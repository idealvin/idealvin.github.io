<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Documents for co v1.2 - Alvin&#39;s blog</title>
    <meta property="og:title" content="Documents for co v1.2 - Alvin&#39;s blog">
    

    
    <meta property="keywords" content ="idealvin,co,libco,coroutine,golang,C&#43;&#43;,log,logging,flag,config,json,unit-test,rpc,http,go-style,golang风格,协程,协程库,日志库,命令行,配置文件,基础库">
    

    <meta name="twitter:card" content="summary">
    
      
    

    
      
      <meta property="og:description" content="Section 1-10 was translated by Leedehai, 11-15 was translated by daidai21. Thanks here.
CO is an elegant and efficient C &#43;&#43; basic library that supports Linux, Windows and Mac platforms. This document &amp;hellip;">
      
    

    
    

    
    <link rel="icon" href="/favicon.ico">
    
<link href='/css/code.css' rel='stylesheet' type='text/css' />


    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/custom.css" />    
    
  </head>

  
  <body class="coding">
    <header class="masthead">
      <h1><a href="/" style="border: none;"><img src="/images/logo.jpg" alt="Alvin Yih"></a></h1>



      <nav class="menu">
  <input id="menu-check" type="checkbox" />
  <label id="menu-label" for="menu-check" class="unselectable">
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/">主页</a></li>
  
  <li><a href="/about/">关于</a></li>
  
  <li><a href="/coding/">编程</a></li>
  
  <li><a href="/essay/">随笔</a></li>
  
  <li><a href="/donate/">捐赠</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      <h1>Documents for co v1.2</h1>

<h3>Alvin
  /  2020-07-27</h3>
<hr>
      </header>



<div class="toc">
<nav id="TableOfContents">
  <ul>
    <li><a href="#1-overview">1. Overview</a></li>
    <li><a href="#2-basic-definitions-def">2. Basic definitions (def)</a>
      <ul>
        <li><a href="#21-fixed-width-integers">2.1 Fixed-width integers</a></li>
        <li><a href="#22-readwrite-1-2-4-8-bytes">2.2 Read/write 1, 2, 4, 8 bytes</a></li>
        <li><a href="#23-disallow_copy_and_assign">2.3 DISALLOW_COPY_AND_ASSIGN</a></li>
        <li><a href="#24-force_cast-type-coercion">2.4 force_cast type coercion</a></li>
        <li><a href="#25-__forceinline-and-__thread">2.5 __forceinline and __thread</a></li>
        <li><a href="#26-unlikely">2.6 unlikely</a></li>
      </ul>
    </li>
    <li><a href="#3-atomic-operations">3. Atomic operations</a></li>
    <li><a href="#4-random-number-generator-random">4. Random number generator (random)</a></li>
    <li><a href="#5-lrumap">5. LruMap</a></li>
    <li><a href="#6-fast-string-casting-for-basic-types-fast">6. Fast string casting for basic types (fast)</a></li>
    <li><a href="#7-efficient-byte-stream">7. Efficient byte stream</a></li>
    <li><a href="#8-efficient-strings-fastring">8. Efficient strings (fastring)</a></li>
    <li><a href="#9-string-operations">9. String operations</a>
      <ul>
        <li><a href="#91-splitting">9.1 Splitting</a></li>
        <li><a href="#92-stripping">9.2 Stripping</a></li>
        <li><a href="#93-replacing">9.3 Replacing</a></li>
        <li><a href="#94-string-to-built-in-types">9.4 String to built-in types</a></li>
        <li><a href="#95-built-in-types-to-string">9.5 Built-in types to string</a></li>
        <li><a href="#96-debug-string">9.6 debug string</a></li>
      </ul>
    </li>
    <li><a href="#10-commandline-arguments-and-config-file-parsing-flag">10. Commandline arguments and config file parsing (flag)</a>
      <ul>
        <li><a href="#101-concepts">10.1 Concepts</a></li>
        <li><a href="#102-initialization-of-flag-library">10.2 initialization of flag library</a></li>
        <li><a href="#103-define-declare-and-use-flag-variables">10.3 Define, declare, and use flag variables</a></li>
        <li><a href="#104-use-flags-in-commandline">10.4 Use flags in commandline</a></li>
        <li><a href="#105-specify-a-config-file-for-program">10.5 Specify a config file for program</a></li>
        <li><a href="#106-auto-generate-config-files">10.6 Auto-generate config files</a></li>
        <li><a href="#107-format-of-config-files">10.7 Format of config files</a></li>
      </ul>
    </li>
    <li><a href="#11-efficient-streaming-log-library-log">11. Efficient streaming log library (log)</a>
      <ul>
        <li><a href="#111-basic-introduction">11.1 Basic introduction</a></li>
        <li><a href="#112-api-introduction">11.2 Api Introduction</a></li>
        <li><a href="#113-print-different-levels-of-logs">11.3 Print different levels of logs</a></li>
        <li><a href="#114-conditional-log-log_if">11.4 Conditional log (LOG_IF)</a></li>
        <li><a href="#115-print-log-every-n-times-log_every_n">11.5 Print log every N times (LOG_EVERY_N)</a></li>
        <li><a href="#116-print-the-first-n-logs-log_first_n">11.6 Print the first N logs (LOG_FIRST_N)</a></li>
        <li><a href="#117-check-enhanced-assert">11.7 CHECK: Enhanced assert</a></li>
        <li><a href="#118-configuration-items">11.8 Configuration items</a></li>
        <li><a href="#119-functional-and-performance-test">11.9 Functional and performance test</a></li>
      </ul>
    </li>
    <li><a href="#12-unit-testing-framework-unitest">12. Unit testing framework (unitest)</a>
      <ul>
        <li><a href="#121-define-test-units-and-use-cases">12.1 Define test units and use cases</a></li>
        <li><a href="#122-run-test-case">12.2 Run test case</a></li>
      </ul>
    </li>
    <li><a href="#13-efficient-json-library-json">13. Efficient json library (json)</a>
      <ul>
        <li><a href="#131-basic-types">13.1 Basic types</a></li>
        <li><a href="#132-array-type">13.2 Array type</a></li>
        <li><a href="#133-object-type">13.3 Object type</a></li>
        <li><a href="#134-json-to-string">13.4 Json to string</a></li>
        <li><a href="#135-string-to-json">13.5 String to json</a></li>
        <li><a href="#136-object-type-adding-and-finding-members-efficiently">13.6 Object type: adding and finding members efficiently</a></li>
        <li><a href="#137-special-characters-in-string-types">13.7 Special characters in string types</a></li>
      </ul>
    </li>
    <li><a href="#14-time-library-time">14. Time library (time)</a>
      <ul>
        <li><a href="#141-monotonic-time">14.1 monotonic time</a></li>
        <li><a href="#142-time-string-nowstr">14.2 Time string (now::str())</a></li>
        <li><a href="#143-sleep">14.3 sleep</a></li>
        <li><a href="#144-timertimer">14.4 Timer(Timer)</a></li>
      </ul>
    </li>
    <li><a href="#15-thread-library-thread">15. Thread library (thread)</a>
      <ul>
        <li><a href="#151-mutex">15.1 Mutex</a></li>
        <li><a href="#152-syncevent">15.2 SyncEvent</a></li>
        <li><a href="#153-thread">15.3 Thread</a></li>
        <li><a href="#154-get-the-id-of-the-current-thread">15.4 Get the id of the current thread</a></li>
        <li><a href="#155-thread_ptr-based-on-tls">15.5 thread_ptr based on TLS</a></li>
        <li><a href="#156-timed-task-scheduler-tasksched">15.6 Timed task scheduler (TaskSched)</a></li>
      </ul>
    </li>
    <li><a href="#16-coroutine-library-co">16. Coroutine library (co)</a>
      <ul>
        <li><a href="#161-basic-concepts">16.1 Basic Concepts</a></li>
        <li><a href="#162-create-coroutines-go">16.2 Create coroutines (go)</a></li>
        <li><a href="#163-coroutine-api">16.3 coroutine api</a></li>
        <li><a href="#164-network-programming">16.4 Network Programming</a></li>
        <li><a href="#165-coroutine-synchronization-mechanism">16.5 Coroutine synchronization mechanism</a></li>
        <li><a href="#166-coroutine-pool">16.6 Coroutine Pool</a></li>
        <li><a href="#167-configuration-items">16.7 Configuration items</a></li>
      </ul>
    </li>
    <li><a href="#17-network-library-so">17. Network library (so)</a>
      <ul>
        <li><a href="#171-tcp-programming">17.1 TCP programming</a></li>
        <li><a href="#172-http-programming">17.2 HTTP Programming</a></li>
        <li><a href="#173-rpc-framework">17.3 rpc framework</a></li>
      </ul>
    </li>
    <li><a href="#18-hash-library">18. Hash library</a></li>
    <li><a href="#19-path-library">19. Path library</a></li>
    <li><a href="#20-file-system-operations-fs">20. File System Operations (fs)</a>
      <ul>
        <li><a href="#201-metadata-operations">20.1 Metadata Operations</a></li>
        <li><a href="#202-basic-file-read-and-write-operations">20.2 Basic file read and write operations</a></li>
        <li><a href="#203-file-stream-fsfstream">20.3 File stream (fs::fstream)</a></li>
      </ul>
    </li>
    <li><a href="#21-system-operations-os">21. System operations (os)</a></li>
    <li><a href="#22-compiling">22. Compiling</a>
      <ul>
        <li><a href="#xmake">xmake</a></li>
        <li><a href="#cmake">cmake</a></li>
      </ul>
    </li>
    <li><a href="#23-donate">23. Donate</a></li>
  </ul>
</nav> 
</div>


<p>Section 1-10 was translated by <a href="https://github.com/Leedehai">Leedehai</a>, 11-15 was translated by <a href="https://github.com/daidai21">daidai21</a>. Thanks here.</p>
<p><a href="https://github.com/idealvin/co/">CO</a> is an elegant and efficient C ++ basic library that supports Linux, Windows and Mac platforms. This document will introduce the components of CO and their usages.</p>
<h2 id="1-overview">1. Overview</h2>
<p><code>CO</code> pursues minimalism and efficiency. It does not rely on third-party libraries such as <a href="https://www.boost.org/">boost</a>, and uses only a few C++11 features.</p>
<ul>
<li>CO contains the following functional components:
<ul>
<li>Basic definitions (def)</li>
<li>Atomic operations (atomic)</li>
<li>Fast random number generator (random)</li>
<li>LruMap</li>
<li>Fast string casting for basic types (fast)</li>
<li>Efficient byte stream (fastream)</li>
<li>Efficient strings (fastring)</li>
<li>String operations (str)</li>
<li>Command line arguments and configuration file parsing library (flag)</li>
<li>Efficient streaming log library (log)</li>
<li>Unit testing framework (unitest)</li>
<li>Efficient json library (json)</li>
<li>Time library (time)</li>
<li>Thread library (thread)</li>
<li>Coroutine library (co)</li>
<li>Network library (so)</li>
<li>Hash library</li>
<li>Path library</li>
<li>File system operations (fs)</li>
<li>System operations (os)</li>
</ul>
</li>
</ul>
<h2 id="2-basic-definitions-def">2. Basic definitions (def)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/def.h">co/def.h</a>.</p>
<h3 id="21-fixed-width-integers">2.1 Fixed-width integers</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"> int8   int16   int32   int64
uint8  uint16  uint32  uint64
</code></pre></div><p>Their widths don&rsquo;t vary across platforms, so there should be no compatibility issues. <a href="https://google.github.io/styleguide/cppguide.html#Integer_Types">Google Code Style</a> suggests that one should not use built-in integer types like <code>short</code>, <code>long</code>, <code>long long</code>, except for <code>int</code>.</p>
<p><code>def.h</code> also provides the minimum and maximum values of the aforementioned integer types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">MAX_UINT8  MAX_UINT16  MAX_UINT32  MAX_UINT64
MAX_INT8   MAX_INT16   MAX_INT32   MAX_INT64
MIN_INT8   MIN_INT16   MIN_INT32   MIN_INT64
</code></pre></div><h3 id="22-readwrite-1-2-4-8-bytes">2.2 Read/write 1, 2, 4, 8 bytes</h3>
<p><code>def.h</code> provides the below macros to facilitate reading/writing 1/2/4/8 bytes of data (note memory alignment is important):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">load8  load16  load32  load64
save8  save16  save32  save64
</code></pre></div><ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">uint64 v;                  <span style="color:#75715e">// 8 bytes
</span><span style="color:#75715e"></span>save32(<span style="color:#f92672">&amp;</span>v, <span style="color:#ae81ff">7</span>);             <span style="color:#75715e">// set the first 4 bytes to 7
</span><span style="color:#75715e"></span>uint16 x <span style="color:#f92672">=</span> load16(<span style="color:#f92672">&amp;</span>v);     <span style="color:#75715e">// read the first 2 bytes of v
</span></code></pre></div><h3 id="23-disallow_copy_and_assign">2.3 DISALLOW_COPY_AND_ASSIGN</h3>
<p>This macro deletes copy constructors and assignment operators in a C++ class.</p>
<ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">T</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    T();
    DISALLOW_COPY_AND_ASSIGN(T);
};
</code></pre></div><h3 id="24-force_cast-type-coercion">2.4 force_cast type coercion</h3>
<p><code>force_cast</code> is an encapsulation of C-style type casting</p>
<ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> force_cast<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">97</span>); <span style="color:#75715e">// char c = (char) 97;
</span></code></pre></div><h3 id="25-__forceinline-and-__thread">2.5 __forceinline and __thread</h3>
<p><a href="https://docs.microsoft.com/en-us/cpp/cpp/inline-functions-cpp?view=vs-2019#inline-__inline-and-__forceinline">__forceinline</a> is a keyword in Visual Studio on Windows. On other platforms, it can be provided by the macro below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define __forceinline __attribute__((always_inline))
</span></code></pre></div><p><a href="https://gcc.gnu.org/onlinedocs/gcc-4.7.4/gcc/Thread-Local.html">__thread</a> is a keyword in GCC to support <a href="https://wiki.osdev.org/Thread_Local_Storage">TLS</a>. On Windows, it can be provided by the macro below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define __thread __declspec(thread)
</span></code></pre></div><ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// get the ID of the current thread
</span><span style="color:#75715e"></span><span style="color:#66d9ef">__forceinline</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">gettid</span>() {
    <span style="color:#66d9ef">static</span> __thread <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">if</span> (id <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> id;
    <span style="color:#66d9ef">return</span> id <span style="color:#f92672">=</span> __gettid();
}
</code></pre></div><h3 id="26-unlikely">2.6 unlikely</h3>
<p>The macro <code>unlikely</code> is used to aid branch predictions in GCC and Clang:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// it is logically equivalent to (v == -1), but provides a hint to the compiler 
</span><span style="color:#75715e">// that the probability of v == -1 is small
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (unlikey(v <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) {
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;v == -1&#34;</span> <span style="color:#f92672">&lt;&lt;</span> endl;
}
</code></pre></div><h2 id="3-atomic-operations">3. Atomic operations</h2>
<p>include: <a href="https://github.com/idealvin/co/tree/master/include/co/atomic.h">co/atomic.h</a>.</p>
<p>Library <code>atomic</code> implements the following atomic operations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">atomic_inc        atomic_dec        atomic_add        atomic_sub
atomic_fetch_inc  atomic_fetch_dec  atomic_fetch_add  atomic_fetch_sub

atomic_or         atomic_and        atomic_xor
atomic_fetch_or   atomic_fetch_and  atomic_fetch_xor

atomic_swap    atomic_compare_swap
atomic_get     atomic_set    atomic_reset
</code></pre></div><p>These operations is suitable for 1-, 2-, 4- and 8-byte data. The <code>fetch</code> versions of <code>inc</code>, <code>dec</code>, <code>add</code>, <code>sub</code>, <code>or</code>, <code>and</code>, <code>xor</code> are different from the vanilla versions, in that the former returns the value before the operations while the latter returns the value after the operations.</p>
<ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> b <span style="color:#f92672">=</span> false;
<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
uint64 u <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

atomic_inc(<span style="color:#f92672">&amp;</span>i);                 <span style="color:#75715e">// return ++i;
</span><span style="color:#75715e"></span>atomic_dec(<span style="color:#f92672">&amp;</span>i);                 <span style="color:#75715e">// return --i;
</span><span style="color:#75715e"></span>atomic_add(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">3</span>);              <span style="color:#75715e">// return i += 3;
</span><span style="color:#75715e"></span>atomic_sub(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">3</span>);              <span style="color:#75715e">// return i -= 3;
</span><span style="color:#75715e"></span>atomic_fetch_inc(<span style="color:#f92672">&amp;</span>u);           <span style="color:#75715e">// return u++;
</span><span style="color:#75715e"></span>
atomic_or(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">8</span>);               <span style="color:#75715e">// return i |= 8;
</span><span style="color:#75715e"></span>atomic_and(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">7</span>);              <span style="color:#75715e">// return i &amp;= 7;
</span><span style="color:#75715e"></span>atomic_xor(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">7</span>);              <span style="color:#75715e">// return i ^= 7;
</span><span style="color:#75715e"></span>atomic_fetch_xor(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">7</span>);        <span style="color:#75715e">// v = i; i ^= 7; return v;
</span><span style="color:#75715e"></span>
atomic_swap(<span style="color:#f92672">&amp;</span>b, true);          <span style="color:#75715e">// v = b; b = true; return v;
</span><span style="color:#75715e"></span>atomic_compare_swap(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">// v = i; if (i == 0) i = 1; return v;
</span><span style="color:#75715e"></span>
atomic_get(<span style="color:#f92672">&amp;</span>u);                 <span style="color:#75715e">// return u;
</span><span style="color:#75715e"></span>atomic_set(<span style="color:#f92672">&amp;</span>u, <span style="color:#ae81ff">7</span>);              <span style="color:#75715e">// u = 7;
</span><span style="color:#75715e"></span>atomic_reset(<span style="color:#f92672">&amp;</span>i);               <span style="color:#75715e">// i = 0;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// atomic operations on pointers
</span><span style="color:#75715e"></span>atomic_set(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0</span>);
atomic_swap(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">8</span>);
atomic_compare_swap(<span style="color:#f92672">&amp;</span>p, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>);
</code></pre></div><h2 id="4-random-number-generator-random">4. Random number generator (random)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/random.h">co/random.h</a>.</p>
<p><code>Random</code> is a speedy pseudo-random number generator, capable of generating random integers between 1 and 2G-2 without consecutive repetitions. Though <a href="https://github.com/google/leveldb/blob/master/util/random.h">leveldb</a> uses this algorithm, this library chose a different constant <code>16385</code>, which is faster.</p>
<ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Random <span style="color:#a6e22e">r</span>(<span style="color:#ae81ff">7</span>);      <span style="color:#75715e">// 7 is the seed, which defaults to 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> r.next(); <span style="color:#75715e">// !! not thread-safe
</span></code></pre></div><h2 id="5-lrumap">5. LruMap</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/lru_map.h">co/lru_map.h</a>.</p>
<p>LRU is a popular caching strategy. When its size grows to the capacity, it will purge the least recently used data. <code>LruMap</code> is based on the implementation of <code>std::list</code> and <code>std::unordered_map</code>. Its elements are stored without order.</p>
<ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">LruMap<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> m(<span style="color:#ae81ff">128</span>);         <span style="color:#75715e">// capacity: 128
</span><span style="color:#75715e"></span>m.insert(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">23</span>);                 <span style="color:#75715e">// when m.size() &gt; 128, delete the last element
</span><span style="color:#75715e"></span>                                 <span style="color:#75715e">// in the internal list (least recently used).
</span><span style="color:#75715e"></span>                                 <span style="color:#75715e">// !! if key already exists, no inseration done
</span><span style="color:#75715e"></span><span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> m.find(<span style="color:#ae81ff">1</span>);             <span style="color:#75715e">// if found, put 1 at the beginning of the list
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (it <span style="color:#f92672">!=</span> m.end()) m.erase(it);  <span style="color:#75715e">// erase by iterator
</span><span style="color:#75715e"></span>m.erase(it<span style="color:#f92672">-&gt;</span>first);              <span style="color:#75715e">// erase by key
</span></code></pre></div><h2 id="6-fast-string-casting-for-basic-types-fast">6. Fast string casting for basic types (fast)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/fast.h">co/fast.h</a>.</p>
<p>Library <code>fast</code> provides functions below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">u32toh  u64toh  u32toa  u64toa  i32toa  i64toa  dtoa
</code></pre></div><p><code>xtoh</code>-family converts an integer into a hexadecimal string. It caches the results corresponding to the first 256 numbers (2 bytes) in a table. Testing across platforms suggested it is 10-25 times faster than <code>snprintf</code>.</p>
<p><code>xtoa</code>-family converts an integer into an ASCII decimal string. It caches the results corresponding to the first 10000 numbers (4-bytes). Testing across platforms suggested it is 10-25 times faster than <code>snprintf</code>.</p>
<p><code>dtoa</code> uses the implementation by <a href="https://github.com/miloyip">Milo Yip</a>, see <a href="https://github.com/miloyip/dtoa-benchmark">miloyip/dtoa-benchmark</a> for details. The early implementation based on <code>LruMap</code> was deprecated.</p>
<ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">32</span>];
<span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> fast<span style="color:#f92672">::</span>u32toh(<span style="color:#ae81ff">255</span>, buf); <span style="color:#75715e">// &#34;0xff&#34;, len is 4
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> fast<span style="color:#f92672">::</span>i32toa(<span style="color:#f92672">-</span><span style="color:#ae81ff">99</span>, buf); <span style="color:#75715e">// &#34;-99&#34;, len is 3
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> fast<span style="color:#f92672">::</span>dtoa(<span style="color:#ae81ff">0.123</span>, buf); <span style="color:#75715e">// &#34;0.123&#34;, len is 5
</span></code></pre></div><h2 id="7-efficient-byte-stream">7. Efficient byte stream</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/fastream.h">co/fastream.h</a>.</p>
<p><code>std::ostringstream</code> in the C++ standard library is significantly less performant than <code>snprintf</code>. <code>fastream</code> inherits from the <code>fast::stream</code> class and supports streaming output and binary append operations. Among them, streaming output is about 10~30 times faster than snprintf on different platforms.</p>
<ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastream <span style="color:#a6e22e">fs</span>(<span style="color:#ae81ff">1024</span>);          <span style="color:#75715e">// preallocate 1K memory
</span><span style="color:#75715e"></span>fs <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello world&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;  <span style="color:#75715e">// stream mode
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span>;
<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">8</span>];
fs.append(buf, <span style="color:#ae81ff">8</span>);      <span style="color:#75715e">// append 8 bytes
</span><span style="color:#75715e"></span>fs.append(<span style="color:#f92672">&amp;</span>i, <span style="color:#ae81ff">4</span>);       <span style="color:#75715e">// append 4 bytes
</span><span style="color:#75715e"></span>fs.append(i);           <span style="color:#75715e">// append 8 bytes, same as fs.append(&amp;i, 4)
</span><span style="color:#75715e"></span>fs.append((int16) <span style="color:#ae81ff">23</span>);  <span style="color:#75715e">// append 2 bytes
</span><span style="color:#75715e"></span>fs.append(<span style="color:#e6db74">&#39;c&#39;</span>);         <span style="color:#75715e">// append a single character
</span><span style="color:#75715e"></span>fs.append(<span style="color:#ae81ff">100</span>, <span style="color:#e6db74">&#39;c&#39;</span>);    <span style="color:#75715e">// append 100 character &#39;c&#39;
</span><span style="color:#75715e"></span>fs.append(<span style="color:#e6db74">&#39;c&#39;</span>, <span style="color:#ae81ff">100</span>);    <span style="color:#75715e">// append 100 character &#39;c&#39;
</span><span style="color:#75715e"></span>
fs.c_str();             <span style="color:#75715e">// return a C-style string
</span><span style="color:#75715e"></span>fs.str();               <span style="color:#75715e">// return a C++ string with deep-copy
</span><span style="color:#75715e"></span>fs.data();              <span style="color:#75715e">// return pointer to data
</span><span style="color:#75715e"></span>fs.size();              <span style="color:#75715e">// return data length
</span><span style="color:#75715e"></span>fs.capacity();          <span style="color:#75715e">// capacity
</span><span style="color:#75715e"></span>
fs.reserve(<span style="color:#ae81ff">4096</span>);       <span style="color:#75715e">// reserve at least 4K memory
</span><span style="color:#75715e"></span>fs.resize(<span style="color:#ae81ff">32</span>);          <span style="color:#75715e">// size -&gt; 32, content in buffer is unchanged
</span><span style="color:#75715e"></span>fs.clear();             <span style="color:#75715e">// size -&gt; 0
</span><span style="color:#75715e"></span>fs.swap(fastream());    <span style="color:#75715e">// swap
</span></code></pre></div><ul>
<li>Precautions</li>
</ul>
<p>For performance reasons, no security check is performed during the <code>append</code> operation for <code>fastream</code>. The following code is not safe:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastream f;
f.append(<span style="color:#e6db74">&#34;hello&#34;</span>);
f.append(f.c_str() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// unsafe, internal memory overlap is not considered
</span></code></pre></div><h2 id="8-efficient-strings-fastring">8. Efficient strings (fastring)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/fastring.h">co/fastring.h</a>.</p>
<p><code>fastring</code> is a string type in co. Like <code>fastream</code>, it inherits from <code>fast::stream</code>, so in addition to basic string operations, it also supports streaming output operations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastring s;
s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello world &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1234567</span>;
</code></pre></div><p>In the early implementation of fastring, reference counting was used, which made the copying behavior of fastring different from <code>std::string</code>, which caused confusion. To better replace std::string, reference counting has been removed from the refactored version.</p>
<p>Fastring supports almost all operations of fastream, but one thing is different from fastream, fastring will perform security check when <code>append</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastring <span style="color:#a6e22e">s</span>(<span style="color:#e6db74">&#34;hello&#34;</span>);
fastream f;
f.append(<span style="color:#e6db74">&#34;hello&#34;</span>);

s.append(s.c_str() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// safe, memory overlap detected, special processing
</span><span style="color:#75715e"></span>f.append(f.c_str() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// unsafe, does not check memory overlap
</span></code></pre></div><ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastring s;                <span style="color:#75715e">// empty string, without memory allocation
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">s</span>(<span style="color:#ae81ff">32</span>);            <span style="color:#75715e">// empty string, with memory preallocated (32 bytes)
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">s</span>(<span style="color:#e6db74">&#34;hello&#34;</span>);       <span style="color:#75715e">// non-empty strings
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">s</span>(<span style="color:#ae81ff">88</span>, <span style="color:#e6db74">&#39;x&#39;</span>);       <span style="color:#75715e">// initialize s to be 88 &#39;x&#39; characters
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">s</span>(<span style="color:#e6db74">&#39;x&#39;</span>, <span style="color:#ae81ff">88</span>);       <span style="color:#75715e">// initialize s to be 88 &#39;x&#39; characters
</span><span style="color:#75715e"></span>fastring t <span style="color:#f92672">=</span> s;            <span style="color:#75715e">// create a new string through memory copy
</span><span style="color:#75715e"></span>
s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;       <span style="color:#75715e">// streaming output
</span><span style="color:#75715e"></span>s <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;xx&#34;</span>;                 <span style="color:#75715e">// append
</span><span style="color:#75715e"></span>s.append(<span style="color:#e6db74">&#34;xx&#34;</span>);            <span style="color:#75715e">// append  &lt;==&gt;  s += &#34;xx&#34;;
</span><span style="color:#75715e"></span>s.swap(fastring());        <span style="color:#75715e">// swap
</span><span style="color:#75715e"></span>
s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;xxx&#34;</span>;                 <span style="color:#75715e">// +
</span><span style="color:#75715e"></span>s <span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;xxx&#34;</span>;                 <span style="color:#75715e">// &gt;
</span><span style="color:#75715e"></span>s <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#34;zzz&#34;</span>                  <span style="color:#75715e">// &lt;
</span><span style="color:#75715e"></span>s <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#34;zz&#34;</span>                  <span style="color:#75715e">// &lt;=
</span><span style="color:#75715e"></span>s <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#34;zz&#34;</span>                  <span style="color:#75715e">// &gt;=
</span><span style="color:#75715e"></span>
s.find(<span style="color:#e6db74">&#39;c&#39;</span>);               <span style="color:#75715e">// character lookup
</span><span style="color:#75715e"></span>s.find(<span style="color:#e6db74">&#34;xx&#34;</span>, <span style="color:#ae81ff">3</span>);           <span style="color:#75715e">// substring lookup starting from index 3
</span><span style="color:#75715e"></span>s.rfind(<span style="color:#e6db74">&#39;c&#39;</span>);              <span style="color:#75715e">// character reverse-lookup
</span><span style="color:#75715e"></span>s.rfind(<span style="color:#e6db74">&#34;xx&#34;</span>);             <span style="color:#75715e">// substring reverse-lookup
</span><span style="color:#75715e"></span>s.find_first_of(<span style="color:#e6db74">&#34;xy&#34;</span>);     <span style="color:#75715e">// find the first occurence of a character in &#34;xy&#34;
</span><span style="color:#75715e"></span>s.find_first_not_of(<span style="color:#e6db74">&#34;xy&#34;</span>); <span style="color:#75715e">// find the first occurence of a character not in &#34;xy&#34;
</span><span style="color:#75715e"></span>s.find_last_of(<span style="color:#e6db74">&#34;xy&#34;</span>);      <span style="color:#75715e">// find the last occurence of a character in &#34;xy&#34;
</span><span style="color:#75715e"></span>s.find_last_not_of(<span style="color:#e6db74">&#34;xy&#34;</span>);  <span style="color:#75715e">// find the last occurence of a character not in &#34;xy&#34;
</span><span style="color:#75715e"></span>s.starts_with(<span style="color:#e6db74">&#39;x&#39;</span>);        <span style="color:#75715e">// check whether s starts with &#39;x&#39;
</span><span style="color:#75715e"></span>s.starts_with(<span style="color:#e6db74">&#34;xx&#34;</span>);       <span style="color:#75715e">// check whether s starts with &#34;xx&#34;
</span><span style="color:#75715e"></span>s.ends_with(<span style="color:#e6db74">&#39;x&#39;</span>);          <span style="color:#75715e">// check whether s ends with &#39;x&#39;
</span><span style="color:#75715e"></span>s.ends_with(<span style="color:#e6db74">&#34;xx&#34;</span>);         <span style="color:#75715e">// check whether s ends with &#34;xx&#34;
</span><span style="color:#75715e"></span>
s.replace(<span style="color:#e6db74">&#34;xxx&#34;</span>, <span style="color:#e6db74">&#34;yy&#34;</span>);    <span style="color:#75715e">// replace &#34;xxx&#34; in s with &#34;yy&#34;
</span><span style="color:#75715e"></span>s.replace(<span style="color:#e6db74">&#34;xxx&#34;</span>, <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#ae81ff">3</span>); <span style="color:#75715e">// replace &#34;xxx&#34; in s with &#34;yy&#34; at most 3 times
</span><span style="color:#75715e"></span>
s.strip();                 <span style="color:#75715e">// strips whitespaces &#34; \t\r\n&#34; from both ends of s
</span><span style="color:#75715e"></span>s.strip(<span style="color:#e6db74">&#34;ab&#34;</span>);             <span style="color:#75715e">// strips &#39;a&#39;, &#39;b&#39; from both ends of s
</span><span style="color:#75715e"></span>s.strip(<span style="color:#e6db74">&#34;ab&#34;</span>, <span style="color:#e6db74">&#39;l&#39;</span>);        <span style="color:#75715e">// strips &#39;a&#39;, &#39;b&#39; from the left endsof s
</span><span style="color:#75715e"></span>s.strip(<span style="color:#e6db74">&#34;ab&#34;</span>, <span style="color:#e6db74">&#39;r&#39;</span>);        <span style="color:#75715e">// strips &#39;a&#39;, &#39;b&#39; from the right endsof s
</span><span style="color:#75715e"></span>
s.tolower();               <span style="color:#75715e">// convert characters in s to lowercases
</span><span style="color:#75715e"></span>s.toupper();               <span style="color:#75715e">// convert characters in s to uppercases
</span><span style="color:#75715e"></span>s.lower();                 <span style="color:#75715e">// return lowercase of s, without mutating s
</span><span style="color:#75715e"></span>s.upper();                 <span style="color:#75715e">// return uppercase of s, without mutating s
</span><span style="color:#75715e"></span>s.match(<span style="color:#e6db74">&#34;x*y?z&#34;</span>);          <span style="color:#75715e">// glob pattern matching
</span><span style="color:#75715e"></span>                           <span style="color:#75715e">// &#39;*&#39; for any string, &#39;?&#39; for a single character
</span></code></pre></div><ul>
<li>Precautions</li>
</ul>
<p>When fastring contains binary characters, do not use the <code>find</code> series of operations:</p>
<ul>
<li>find()</li>
<li>rfind()</li>
<li>find_first_of()</li>
<li>find_first_not_of()</li>
<li>find_last_of()</li>
<li>find_last_not_of()</li>
</ul>
<p>The above methods are based on <code>strrchr</code>, <code>strstr</code>, <code>strcspn</code>, <code>strspn</code>, etc. When the string contains binary characters, there is no guarantee that the correct result will be obtained.</p>
<h2 id="9-string-operations">9. String operations</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/str.h">co/str.h</a>.</p>
<h3 id="91-splitting">9.1 Splitting</h3>
<p><code>split</code> splits a string into several pieces.</p>
<ul>
<li>Prototype</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// @s: the original string: fastring or const char*
</span><span style="color:#75715e">// @c: delimiter: a single character or a &#39;\0&#39;-terminated string
</span><span style="color:#75715e">// @n: allowed times of splitting: 0/-1 means no limit (default is 0)
</span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>fastring<span style="color:#f92672">&gt;</span> split(s, c, n<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>);
</code></pre></div><ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">str<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;x y z&#34;</span>, <span style="color:#e6db74">&#39; &#39;</span>);     <span style="color:#75715e">// -&gt;  [ &#34;x&#34;, &#34;y&#34;, &#34;z&#34; ]
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;|x|y|&#34;</span>, <span style="color:#e6db74">&#39;|&#39;</span>);     <span style="color:#75715e">// -&gt;  [ &#34;&#34;, &#34;x&#34;, &#34;y&#34; ]
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;xooy&#34;</span>, <span style="color:#e6db74">&#34;oo&#34;</span>);     <span style="color:#75715e">// -&gt;  [ &#34;x&#34;, &#34;y&#34;]
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;xooy&#34;</span>, <span style="color:#e6db74">&#39;o&#39;</span>);      <span style="color:#75715e">// -&gt;  [ &#34;x&#34;, &#34;&#34;, &#34;y&#34; ]
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;xooy&#34;</span>, <span style="color:#e6db74">&#39;o&#39;</span>, <span style="color:#ae81ff">1</span>);   <span style="color:#75715e">// -&gt;  [ &#34;x&#34;, &#34;oy&#34; ]
</span></code></pre></div><h3 id="92-stripping">9.2 Stripping</h3>
<p><code>strip</code> strips away certain character on one or both ends of a string, and returns the new string (the original is intact).</p>
<ul>
<li>Prototype</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// @s: the original string: fastring or const char*
</span><span style="color:#75715e">// @c: the set of characters to be stripped: a single character or a string
</span><span style="color:#75715e">// @d: which end: &#39;l&#39;/&#39;L&#39; means the left end, &#39;r&#39;/&#39;R&#39; means the right ends,
</span><span style="color:#75715e">//                &#39;b&#39; (the default) means both ends
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">strip</span>(s, c<span style="color:#f92672">=</span><span style="color:#e6db74">&#34; </span><span style="color:#ae81ff">\t\r\n</span><span style="color:#e6db74">&#34;</span>, d<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;b&#39;</span>);
</code></pre></div><ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">str<span style="color:#f92672">::</span>strip(<span style="color:#e6db74">&#34;abxxa&#34;</span>, <span style="color:#e6db74">&#34;ab&#34;</span>);       <span style="color:#75715e">// -&gt; &#34;xx&#34;    strip both ends
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>strip(<span style="color:#e6db74">&#34;abxxa&#34;</span>, <span style="color:#e6db74">&#34;ab&#34;</span>, <span style="color:#e6db74">&#39;l&#39;</span>);  <span style="color:#75715e">// -&gt; &#34;xxa&#34;   strip the left end
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>strip(<span style="color:#e6db74">&#34;abxxa&#34;</span>, <span style="color:#e6db74">&#34;ab&#34;</span>, <span style="color:#e6db74">&#39;r&#39;</span>);  <span style="color:#75715e">// -&gt; &#34;abxx&#34;  strip the right end
</span></code></pre></div><h3 id="93-replacing">9.3 Replacing</h3>
<p><code>replace</code> replaces substrings of the original, and returns the new string (the original is intact).</p>
<ul>
<li>Prototype</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// @s:    the original string: fastring or const char*
</span><span style="color:#75715e">// @sub:  old substring to be replaced
</span><span style="color:#75715e">// @to:   new substring to be replaced with
</span><span style="color:#75715e">// @n:    allowed times of replacing: 0/-1 means no limit (default is 0)
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">replace</span>(s, sub, to, n<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>);
</code></pre></div><ul>
<li>Examples</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">str<span style="color:#f92672">::</span>replace(<span style="color:#e6db74">&#34;xooxoox&#34;</span>, <span style="color:#e6db74">&#34;oo&#34;</span>, <span style="color:#e6db74">&#34;ee&#34;</span>);     <span style="color:#75715e">// -&gt; &#34;xeexeex&#34;
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>replace(<span style="color:#e6db74">&#34;xooxoox&#34;</span>, <span style="color:#e6db74">&#34;oo&#34;</span>, <span style="color:#e6db74">&#34;ee&#34;</span>, <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">// -&gt; &#34;xeexoox&#34;
</span></code></pre></div><h3 id="94-string-to-built-in-types">9.4 String to built-in types</h3>
<p>The library provides the following strings to convert a string into primitive types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">to_int32  to_int64  to_uint32  to_uint64  to_bool  to_double
</code></pre></div><ul>
<li>
<p>Notes</p>
<ul>
<li>if conversion errs, throw an exception of <code>const char*</code> type</li>
<li>when converting to integers, the parameter could end with unit <code>k</code>, <code>m</code>, <code>g</code>, <code>t</code>, <code>p</code> (case-insensitive).</li>
</ul>
</li>
<li>
<p>Examples</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_bool(<span style="color:#e6db74">&#34;false&#34;</span>);    <span style="color:#75715e">// &#34;true&#34; or &#34;1&#34; -&gt; true
</span><span style="color:#75715e"></span>                                   <span style="color:#75715e">// &#34;false&#34; or &#34;0&#34; -&gt; false
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span> x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_double(<span style="color:#e6db74">&#34;3.14&#34;</span>); <span style="color:#75715e">// 3.14
</span><span style="color:#75715e"></span>
int32 x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_int32(<span style="color:#e6db74">&#34;-23&#34;</span>);    <span style="color:#75715e">// -23
</span><span style="color:#75715e"></span>int64 x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_int64(<span style="color:#e6db74">&#34;4k&#34;</span>);     <span style="color:#75715e">// 4096
</span><span style="color:#75715e"></span>uint32 x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_uint32(<span style="color:#e6db74">&#34;8M&#34;</span>);   <span style="color:#75715e">// 8 &lt;&lt; 20
</span><span style="color:#75715e"></span>uint64 x <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>to_uint64(<span style="color:#e6db74">&#34;8T&#34;</span>);   <span style="color:#75715e">// 8ULL &lt;&lt; 40
</span></code></pre></div><h3 id="95-built-in-types-to-string">9.5 Built-in types to string</h3>
<p>The library provides function <code>from</code> to convert a built-in type to string.</p>
<ul>
<li>Examples:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastring s <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>from(true);  <span style="color:#75715e">// -&gt; &#34;true&#34;
</span><span style="color:#75715e"></span>fastring s <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>from(<span style="color:#ae81ff">23</span>);    <span style="color:#75715e">// -&gt; &#34;23&#34;
</span><span style="color:#75715e"></span>fastring s <span style="color:#f92672">=</span> str<span style="color:#f92672">::</span>from(<span style="color:#ae81ff">3.14</span>);  <span style="color:#75715e">// -&gt; &#34;3.14&#34;
</span></code></pre></div><h3 id="96-debug-string">9.6 debug string</h3>
<p>The library provides function <code>dbg</code> to convert an object to a string for debugging.</p>
<ul>
<li>Prototype</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// @v: built-in types, sttings, or common STL containers (vector, map, set)
</span><span style="color:#75715e"></span>fastring dbg<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(v);
</code></pre></div><ul>
<li>Example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> v { <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span> };
std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> s { <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span> };
std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> m { {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>}, {<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>} };
str<span style="color:#f92672">::</span>dbg(v);    <span style="color:#75715e">// -&gt; &#34;[1,2,3]&#34;
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>dbg(s);    <span style="color:#75715e">// -&gt; &#34;{1,2,3}&#34;
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>dbg(m);    <span style="color:#75715e">// -&gt; &#34;{1:1,2:2}
</span><span style="color:#75715e"></span>
str<span style="color:#f92672">::</span>dbg(true); <span style="color:#75715e">// -&gt; &#34;true&#34;
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>dbg(<span style="color:#ae81ff">23</span>);   <span style="color:#75715e">// -&gt; &#34;23&#34;
</span><span style="color:#75715e"></span>str<span style="color:#f92672">::</span>dbg(<span style="color:#e6db74">&#34;23&#34;</span>); <span style="color:#75715e">// -&gt; &#34;\&#34;23\&#34;&#34;, string, with quotes added
</span></code></pre></div><ul>
<li>If the parameter string contains <code>&quot;</code>, the returned string from <code>dbg()</code> may look weird. But it is fine in most cases since the function is used to print logs.</li>
</ul>
<h2 id="10-commandline-arguments-and-config-file-parsing-flag">10. Commandline arguments and config file parsing (flag)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/flag.h">co/flag.h</a>.</p>
<h3 id="101-concepts">10.1 Concepts</h3>
<p>Library <code>flag</code> is a commandline arguments and configuration file parser like <a href="https://github.com/gflags/gflags">google gflags</a>. The code defines static global variables, and parses commandline arguments and configuration file at runtime, and modifies the value of these variables accordingly.</p>
<h4 id="1011-flag-variables">10.1.1 flag variables</h4>
<p><strong>flag variables</strong> refer to the static global variables defined by macros in this library. For example, the code snippet below defines a flag variable named <code>x</code>, and its corresponding global variable is named <code>FLG_x</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_bool(x, false, <span style="color:#e6db74">&#34;xxx&#34;</span>); <span style="color:#75715e">// bool FLG_x = false;
</span></code></pre></div><p>The library supports 7 types of flag variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span>, int32, int64, uint32, uint64, <span style="color:#66d9ef">double</span>, string
</code></pre></div><h4 id="1012-command-line-flags">10.1.2 command line flags</h4>
<p>Strings in commandline arguments often take the form of <code>-x=y</code>. Here, <code>x</code> is a <strong>commandline flag</strong> (<strong>flag</strong> below). Flags in the commandline and flag variables in the code are one-to-one mapped to each other. The library is flexible for ease of using:</p>
<ul>
<li>the leading <code>-</code> can be omitted from <code>-x=y</code>, so you can write <code>x=y</code>.</li>
<li><code>-x=y</code> can be also writen as <code>-x y</code>.</li>
<li>the number of <code>-</code> before <code>x=y</code> is unlimited.</li>
<li>for boolean flags, <code>-b=true</code> can be abbreviated as <code>-b</code> (the leading <code>-</code> must be kept when using this abbreviation).</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./exe -b -i<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span> s<span style="color:#f92672">=</span>hello xx  <span style="color:#75715e"># b,i,s are flags, but xx is not</span>
</code></pre></div><h3 id="102-initialization-of-flag-library">10.2 initialization of flag library</h3>
<p>The library provides only one API <code>flag::init()</code>. It is used to initialize the library and parses commandline arguments and config files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Workflow
</span><span style="color:#75715e">// 1. Scan commandline arguments, and divide it into flag and non-flag.
</span><span style="color:#75715e">// 2. Update the value of FLG_config according to the flag arguments. 
</span><span style="color:#75715e">//    If it is not empty, parse the given config file.
</span><span style="color:#75715e">// 3. Update the values of other flag variables based on the flag arguments.
</span><span style="color:#75715e">// 4. If FLG_mkconf is not empty, generate a config file and exit.
</span><span style="color:#75715e">// 5. if FLG_daemon is true, run the program in the background.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// If an error is encountered while parsing, output an error message and exit.
</span><span style="color:#75715e">// If no error is encountered, return a list of non-flag arguments.
</span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>fastring<span style="color:#f92672">&gt;</span> init(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv);
</code></pre></div><p>This function needs to be called upon entering <code>main()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/flag.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
    flag<span style="color:#f92672">::</span>init(argc, argv);
}
</code></pre></div><h3 id="103-define-declare-and-use-flag-variables">10.3 Define, declare, and use flag variables</h3>
<h4 id="1031-define-flag-variables">10.3.1 Define flag variables</h4>
<p>This library implements 7 macros to define 7 different flag variable types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_bool  DEF_int32  DEF_int64  DEF_uint32  DEF_uint64  DEF_double  DEF_string
</code></pre></div><p>The snippet below defines two types of flag variables; one is boolean and the other is string:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_bool(b, false, <span style="color:#e6db74">&#34;comments&#34;</span>);  <span style="color:#75715e">// bool FLG_b = false;
</span><span style="color:#75715e"></span>DEF_string(s, <span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#e6db74">&#34;comments&#34;</span>);  <span style="color:#75715e">// fastring FLG_s = &#34;x&#34;;
</span></code></pre></div><p>Macro <code>DEF_xxx</code> has three parameter: the first is the flag variable name, the second is the default value, and the third is the comments. Note that:</p>
<ul>
<li>the flag variable is global, and thus they shouldn&rsquo;t be defined in a header,</li>
<li>the name of the flag variable should be unique.</li>
</ul>
<h4 id="1032-declare-flag-variables">10.3.2 Declare flag variables</h4>
<p>This library also implements 7 macros to define 7 different flag variable types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEC_bool  DEC_int32  DEC_int64  DEC_uint32  DEC_uint64  DEC_double  DEC_string
</code></pre></div><p>The snippet below declares a variable of <code>int32</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEC_int32(i32); <span style="color:#75715e">// extern int32 FLG_i32;
</span></code></pre></div><p>Macro <code>DEC_xxx</code> has only one parameter, which is the flag variable name. Each variable can only be defined once, but can be declared multiple times. Declarations are generally used to refer to flag variables defined elsewhere.</p>
<h4 id="1033-use-flag-variables">10.3.3 Use flag variables</h4>
<p>After being defined or declared, the flag variables can be used like ordinary variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEC_bool(b);
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>FLG_b) std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;b is false&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;   

DEF_string(s, <span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#e6db74">&#34;xxx&#34;</span>);
FLG_s <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34; world&#34;</span>;
std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> FLG_s <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</code></pre></div><h3 id="104-use-flags-in-commandline">10.4 Use flags in commandline</h3>
<h4 id="1041-set-flag-variables-values-in-commandline">10.4.1 Set flag variables&rsquo; values in commandline:</h4>
<p>Assume the program defines the following flags:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_bool(x, false, <span style="color:#e6db74">&#34;bool x&#34;</span>);
DEF_bool(y, false, <span style="color:#e6db74">&#34;bool y&#34;</span>);
DEF_int32(i, <span style="color:#f92672">-</span><span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;int32&#34;</span>);
DEF_uint64(u, <span style="color:#ae81ff">64</span>, <span style="color:#e6db74">&#34;uint64&#34;</span>);
DEF_double(d, <span style="color:#ae81ff">3.14</span>, <span style="color:#e6db74">&#34;double&#34;</span>);
DEF_string(s, <span style="color:#e6db74">&#34;hello world&#34;</span>, <span style="color:#e6db74">&#34;string&#34;</span>);
</code></pre></div><p>The flags&rsquo; values can be modified in commandline:</p>
<ul>
<li>
<p><code>-x=y</code> can be also writen as <code>-x y</code> or <code>x=y</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx -i<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> u<span style="color:#f92672">=</span><span style="color:#ae81ff">88</span> -s<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello world&#34;</span>
./xx -i <span style="color:#ae81ff">8</span> -u <span style="color:#ae81ff">88</span> -s <span style="color:#e6db74">&#34;hello world&#34;</span>
</code></pre></div></li>
<li>
<p>For boolean flags, the <code>true</code> value can be omitted</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx -x     <span style="color:#75715e"># -x=true</span>
</code></pre></div></li>
<li>
<p>When multiple boolean flags are set to <code>true</code> and their names are single characters, they can be combined</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx -xy    <span style="color:#75715e"># -x=true -y=true</span>
</code></pre></div></li>
<li>
<p>Integer flags can have a trailing unit symbol <code>k</code>, <code>m</code>, <code>g</code>, <code>t</code>, or <code>p</code> (case-insensitive).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx i<span style="color:#f92672">=</span>-4k  <span style="color:#75715e"># i=-4096</span>
</code></pre></div></li>
<li>
<p>Integer flags&rsquo; values can also be octal or hexadecimal</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx i<span style="color:#f92672">=</span><span style="color:#ae81ff">032</span>  <span style="color:#75715e"># i=26    octal</span>
./xx u<span style="color:#f92672">=</span>0xff <span style="color:#75715e"># u=255   hexadecimal</span>
</code></pre></div></li>
</ul>
<h4 id="1042-help-messages">10.4.2 Help messages</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./xx --help
usage:
    ./xx --                   print flags info
    ./xx --help               print this help info
    ./xx --mkconf             generate config file
    ./xx --daemon             run as a daemon <span style="color:#f92672">(</span>Linux<span style="color:#f92672">)</span>
    ./xx xx.conf              run with config file
    ./xx config<span style="color:#f92672">=</span>xx.conf       run with config file
    ./xx -x -i<span style="color:#f92672">=</span>8k -s<span style="color:#f92672">=</span>ok       run with commandline flags
    ./xx -x -i 8k -s ok       run with commandline flags
    ./xx x<span style="color:#f92672">=</span>true i<span style="color:#f92672">=</span><span style="color:#ae81ff">8192</span> s<span style="color:#f92672">=</span>ok   run with commandline flags
</code></pre></div><h4 id="1043-flag-variable-list">10.4.3 Flag variable list</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./xx --
--config: .path of config file
	 type: string	     default: <span style="color:#e6db74">&#34;&#34;</span>
	 from: ../../base/flag.cc
--mkconf: .generate config file
	 type: bool	     default: false
	 from: ../../base/flag.cc
</code></pre></div><h3 id="105-specify-a-config-file-for-program">10.5 Specify a config file for program</h3>
<p>A configuration file can be specified for a program with flag <code>config</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx config<span style="color:#f92672">=</span>xx.conf
./xx xx.conf    <span style="color:#75715e"># if the config file name ends with &#39;.conf&#39; or &#39;config&#39; and</span>
                <span style="color:#75715e"># it&#39;s the first non-flag parameter, config= can be omitted</span> 
./xx -x xx.conf <span style="color:#75715e"># -x is a flag, so xx.conf is the first non-flag parameter</span>
</code></pre></div><p>Also, the config file can be specified by modifying the value of <code>FLG_config</code> before invoking <code>flag::init()</code>.</p>
<h3 id="106-auto-generate-config-files">10.6 Auto-generate config files</h3>
<p>A config file can be auto-generated by using <code>--mkconf</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">./xx --mkconf          <span style="color:#75715e"># generate xx.conf in the same directory of xx</span>
./xx --mkconf -x u<span style="color:#f92672">=</span><span style="color:#ae81ff">88</span>  <span style="color:#75715e"># replace default values with specified values</span>
</code></pre></div><p>Configuration items are sorted by level, file name, and line number of code. When defining the flag, you can add <code>#n</code> at the beginning of the comments to specify the level. <code>n</code> must be an integer between 0 and 99. If not specified, it defaults to 10.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Specify the level as 0 (the lower level ranks first)
</span><span style="color:#75715e"></span>DEF_bool (daemon, false, <span style="color:#e6db74">&#34;# 0 run program as a daemon&#34;</span>);
</code></pre></div><ul>
<li>Special notes:
<ul>
<li>Flags whose comments start with <code>.</code> are <strong>hidden</strong> and will not be present in the generated config file, but <code>./xx --</code> still displays them.</li>
<li>Flag whose comments are empty are <strong>stealth</strong>, which means they will not be present in the generated config file, and won&rsquo;t be displayed by <code>./xx --</code>.</li>
</ul>
</li>
</ul>
<h3 id="107-format-of-config-files">10.7 Format of config files</h3>
<p>THe library allows a flexible format for config files:</p>
<ul>
<li>Ignore whitespaces before or at the end of lines, so manually writing them is freer and less error-prone.</li>
<li><code>#</code> and <code>//</code> stands for comments. Block comments and trailing comments are supported.</li>
<li>each line has at most one flag, in the form of <code>x = y</code> for clarity.</li>
<li>One or more whitespaces can be inserted before or after <code>=</code>.</li>
<li>Lines can be concatenated with <code>\</code> at the end of the previous line.</li>
<li>No escaping is supported to prevent ambiguity.</li>
</ul>
<p>An example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">   <span style="color:#75715e"># config file: xx.conf</span>
     daemon <span style="color:#f92672">=</span> false            <span style="color:#75715e"># background program (defined in co/flag)</span>
     boo <span style="color:#f92672">=</span> true                <span style="color:#75715e"># cannot be simplified as &#39;-boo&#39;</span>

     s <span style="color:#f92672">=</span>                       <span style="color:#75715e"># empty string</span>
     s <span style="color:#f92672">=</span> hello <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>         world                 <span style="color:#75715e"># s = &#34;helloworld&#34;</span>
     s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://github.com&#34;</span>   <span style="color:#75715e"># &#39;#&#39; and &#39;//&#39; are not comments in a quoted string</span>
     s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;I&#39;m ok&#34;</span>              <span style="color:#75715e"># string, use double quotes on both ends</span>
     s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;how are &#34;U&#34;&#39;</span>         <span style="color:#75715e"># string, use single quotes on both ends</span>
     i32 <span style="color:#f92672">=</span> 4k                  <span style="color:#75715e"># 4096, support unit: k,m,g,t,p (case-insensitive)</span>
     i32 <span style="color:#f92672">=</span> <span style="color:#ae81ff">032</span>                 <span style="color:#75715e"># octal, i32 = 26</span>
     i32 <span style="color:#f92672">=</span> 0xff                <span style="color:#75715e"># hexadecima, i32 = 255</span>
     pi <span style="color:#f92672">=</span> 3.14159              <span style="color:#75715e"># double type</span>
</code></pre></div><h2 id="11-efficient-streaming-log-library-log">11. Efficient streaming log library (log)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/log.h">co/log.h</a>.</p>
<h3 id="111-basic-introduction">11.1 Basic introduction</h3>
<p>The <code>log</code> library is a C++ streaming log library similar to <a href="https://github.com/google/glog">google glog</a>. Printing logs is more convenient and safer than the printf series of functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello world&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</code></pre></div><p>The internal implementation of the log library uses an asynchronous method. Logs are first written to the cache. After a certain amount or more than a certain time, the background thread writes all logs to the file together. The performance is improved by 20 to 150 times compared to glog on different platforms.</p>
<p>The following table is the test result of continuously printing 1 million (about 50 bytes each) info level logs on different platforms:</p>
<table>
<thead>
<tr>
<th>log vs glog</th>
<th>google glog</th>
<th>co/log</th>
</tr>
</thead>
<tbody>
<tr>
<td>win2012 HDD</td>
<td>1.6MB/s</td>
<td>180MB/s</td>
</tr>
<tr>
<td>win10 SSD</td>
<td>3.7MB/s</td>
<td>560MB/s</td>
</tr>
<tr>
<td>mac SSD</td>
<td>17MB/s</td>
<td>450MB/s</td>
</tr>
<tr>
<td>linux SSD</td>
<td>54MB/s</td>
<td>1023MB/s</td>
</tr>
</tbody>
</table>
<h3 id="112-api-introduction">11.2 Api Introduction</h3>
<p>The log library provides only two API functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>();
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span>();
</code></pre></div><p><code>log:: init()</code> needs to be called once at the beginning of the <code>main</code> function. Since the log library depends on the flag library, the main function is generally written as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/flag.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/log.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
    flag<span style="color:#f92672">::</span>init(argc, argv);
    log<span style="color:#f92672">::</span>init();
}
</code></pre></div><p><code>log::close()</code> writes logs in the cache to a file, and exits the logging thread. The log library internally captures signals such as <code>SIGINT, SIGTERM, SIGQUIT</code>, and writes all cached logs to the log file before the program exits.</p>
<h3 id="113-print-different-levels-of-logs">11.3 Print different levels of logs</h3>
<p>Logs are divided into 5 levels: debug, info, warning, error and fatal. You can use the macros DLOG, LOG, WLOG, ELOG and FLOG to print 5 different levels of logs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DLOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is DEBUG log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is INFO log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
WLOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is WARNING log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
ELOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is ERROR log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
FLOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is FATAL log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</code></pre></div><p>Print the <code>fatal</code> log, which generally indicates that a fatal error occurred in the program. The log library will print the stacktrace information of the current thread and terminate the running of the program.</p>
<h3 id="114-conditional-log-log_if">11.4 Conditional log (LOG_IF)</h3>
<p>The log library also provides the <code>IF</code> version of the macro, which accepts a conditional parameter and prints the log when the specified condition is met.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DLOG_IF(cond) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is DEBUG log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
LOG_IF(cond) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is INFO log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
WLOG_IF(cond) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is WARNING log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
ELOG_IF(cond) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is ERROR log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
FLOG_IF(cond) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is FATAL log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</code></pre></div><h3 id="115-print-log-every-n-times-log_every_n">11.5 Print log every N times (LOG_EVERY_N)</h3>
<p>The log library provides <code>LOG_EVERY_N</code> and other macros that support printing logs every N times. These macros use atomic operations internally to ensure thread safety.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// print log 1, 33, 65......
</span><span style="color:#75715e"></span>DLOG_EVERY_N(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is DEBUG log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
LOG_EVERY_N(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is INFO log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
WLOG_EVERY_N(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is WARNING log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
ELOG_EVERY_N(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is ERROR log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</code></pre></div><p>FLOG does not have this function because the program is dead as soon as FLOG prints.</p>
<h3 id="116-print-the-first-n-logs-log_first_n">11.6 Print the first N logs (LOG_FIRST_N)</h3>
<p>The log library provides <code>LOG_FIRST_N</code> and other macros to support printing the first N logs, these macros also use atomic operations internally to ensure thread safety.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// print the first 10 logs
</span><span style="color:#75715e"></span>DLOG_FIRST_N(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is DEBUG log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
LOG_FIRST_N(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is INFO log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
WLOG_FIRST_N(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is WARNING log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
ELOG_FIRST_N(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;this is ERROR log &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;
</code></pre></div><h3 id="117-check-enhanced-assert">11.7 CHECK: Enhanced assert</h3>
<p>The log library provides a series of CHECK macros, which can be regarded as enhanced asserts. These macros will not be cleared in DEBUG mode.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">CHECK(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;say something here&#34;</span>;
CHECK_EQ(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// ==
</span><span style="color:#75715e"></span>CHECK_NE(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// !=
</span><span style="color:#75715e"></span>CHECK_GE(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// &gt;=
</span><span style="color:#75715e"></span>CHECK_LE(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// &lt;=
</span><span style="color:#75715e"></span>CHECK_GT(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// &gt;  greater than
</span><span style="color:#75715e"></span>CHECK_LT(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);  <span style="color:#75715e">// &lt;  less than
</span></code></pre></div><p>When CHECK failed, the LOG library will first call <code>log::close()</code> to write the logs, then print the stacktrace information of the current thread, and then exit the program.</p>
<h3 id="118-configuration-items">11.8 Configuration items</h3>
<ul>
<li>
<p>log_dir</p>
<p>Specifies the log directory. The default is the <code>logs</code> directory under the current directory. It will be created automatically if it does not exist.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_string(log_dir, <span style="color:#e6db74">&#34;logs&#34;</span>, <span style="color:#e6db74">&#34;Log dir, will be created if not exists&#34;</span>);
</code></pre></div></li>
<li>
<p>log_file_name</p>
<p>Specify the log file name (without path), which is empty by default, and use the program name as the log file name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_string(log_file_name, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;name of log file, using exename if empty&#34;</span>);
</code></pre></div></li>
<li>
<p>min_log_level</p>
<p>Specifies the minimum level of printing logs, which is used to disable low-level logs. The default is 0, and logs of all levels are printed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_int32(min_log_level, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;write logs at or above this level, </span>
                             <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span> (debug<span style="color:#f92672">|</span>info<span style="color:#f92672">|</span>warning<span style="color:#f92672">|</span>error<span style="color:#f92672">|</span>fatal)<span style="color:#e6db74">&#34;);</span>
</code></pre></div></li>
<li>
<p>max_log_file_size</p>
<p>Specifies the maximum size of the log file. The default size is 256M. If the file size exceeds this size, a new log file is generated and the old log file is renamed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_int64(max_log_file_size, <span style="color:#ae81ff">256</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>, <span style="color:#e6db74">&#34;max size of log file, </span>
                                         <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">256</span>MB<span style="color:#e6db74">&#34;);</span>
</code></pre></div></li>
<li>
<p>max_log_file_num</p>
<p>Specifies the maximum number of log files. The default is 8. If this value is exceeded, old log files are deleted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_uint32(max_log_file_num, <span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#34;max number of log files&#34;</span>);
</code></pre></div></li>
<li>
<p>max_log_buffer_size</p>
<p>Specifies the maximum size of the log cache. The default value is 32M. If this value is exceeded, half of the logs are discarded.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_uint32(max_log_buffer_size, <span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>, <span style="color:#e6db74">&#34;max size of log buffer, default: 32MB&#34;</span>);
</code></pre></div></li>
<li>
<p>cout</p>
<p>Terminal log switch. The default is false. If true, also logging to the terminal.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DEF_bool (cout, false, <span style="color:#e6db74">&#34;also logging to terminal&#34;</span>);
</code></pre></div></li>
</ul>
<h3 id="119-functional-and-performance-test">11.9 Functional and performance test</h3>
<p>The test code of the log library can be found in <a href="https://github.com/idealvin/co/blob/master/test/log_test.cc">test/log_test.cc</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># run following commands in the root dir of co</span>
xmake -b log    <span style="color:#75715e"># build log</span>

<span style="color:#75715e"># print different types of logs</span>
xmake r log

<span style="color:#75715e"># also logging to terminal</span>
xmake r log -cout

<span style="color:#75715e"># min_log_level specify the minimum level of output logs</span>
xmake r log -min_log_level<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>   <span style="color:#75715e"># 0-4: debug,info,warning,error,fatal</span> 

<span style="color:#75715e"># performance test, one thread continuously prints 1 million info-level logs</span>
xmake r log -perf
</code></pre></div><h2 id="12-unit-testing-framework-unitest">12. Unit testing framework (unitest)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/unitest.h">co/unitest.h</a>.</p>
<p><code>unitest</code> is a unit testing framework similar to <a href="https://github.com/google/googletest">google gtest</a>, but easier to use.</p>
<h3 id="121-define-test-units-and-use-cases">12.1 Define test units and use cases</h3>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/unitest.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/os.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Define a test unit named os with 3 different test cases.
</span><span style="color:#75715e">// When running the unitest program, the parameter -os can be specified 
</span><span style="color:#75715e">// to run only test cases in os.
</span><span style="color:#75715e"></span>DEF_test(os) {
    DEF_case(homedir) {
        EXPECT_NE(os<span style="color:#f92672">::</span>homedir(), std<span style="color:#f92672">::</span>string());
    }

    DEF_case(pid) {
        EXPECT_GE(os<span style="color:#f92672">::</span>pid(), <span style="color:#ae81ff">0</span>);
    }

    DEF_case(cpunum) {
        EXPECT_GT(os<span style="color:#f92672">::</span>cpunum(), <span style="color:#ae81ff">0</span>);
    }
}
</code></pre></div><h3 id="122-run-test-case">12.2 Run test case</h3>
<p>There are some unit test codes under <a href="https://github.com/idealvin/co/tree/master/unitest">co/unitest</a>, which can be compiled and executed as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># run following commands in the root dir of co</span>
xmake -b unitest    <span style="color:#75715e"># build unitest or unitest.exe</span> 

<span style="color:#75715e"># run all test cases</span>
xmake r unitest -a

<span style="color:#75715e"># run only test cases in os unit</span>
xmake r unitest -os
</code></pre></div><h2 id="13-efficient-json-library-json">13. Efficient json library (json)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/json.h">co/json.h</a>.</p>
<p>The <code>json</code> library is designed to be streamlined, efficient, and easy to use. It is comparable to <a href="https://github.com/Tencent/rapidjson">rapidjson</a> in performance. If you use <a href="https://github.com/jemalloc/jemalloc">jemalloc</a>, the performance of <code>parse</code> and <code>stringify</code> will be further improved.</p>
<ul>
<li>Features of the json library
<ul>
<li>Supports 5 basic types: null, bool, int, double and string.</li>
<li>Supports two composite types, array and object.</li>
<li>All types are represented by a single Json class.</li>
<li>There is only one pointer data member in the Json class, <code>sizeof(Json) == sizeof(void*)</code>.</li>
<li>Json has a built-in reference count. The copy operation only increments the reference count (<strong>atomic operation, thread-safe</strong>), no memory copy is performed.</li>
<li>A built-in memory allocator (Jalloc) is used to optimize most memory allocation operations.</li>
</ul>
</li>
</ul>
<h3 id="131-basic-types">13.1 Basic types</h3>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x;                          <span style="color:#75715e">// null
</span><span style="color:#75715e"></span>x.is_null();                     <span style="color:#75715e">// determine if it is null
</span><span style="color:#75715e"></span>
Json x <span style="color:#f92672">=</span> false;                  <span style="color:#75715e">// bool type
</span><span style="color:#75715e"></span>x.is_bool();                     <span style="color:#75715e">// determine whether it is bool type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> b <span style="color:#f92672">=</span> x.get_bool();           <span style="color:#75715e">// get value of bool type
</span><span style="color:#75715e"></span>
Json x <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span>;                    <span style="color:#75715e">// int type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> x.get_int();             <span style="color:#75715e">// get value of int type
</span><span style="color:#75715e"></span>
Json x <span style="color:#f92672">=</span> (int64) <span style="color:#ae81ff">23</span>;             <span style="color:#75715e">// int type, 64-bit
</span><span style="color:#75715e"></span>int64 i <span style="color:#f92672">=</span> x.get_int64();         <span style="color:#75715e">// returns a 64-bit integer
</span><span style="color:#75715e"></span>
Json x <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.14</span>;                   <span style="color:#75715e">// double type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span> d <span style="color:#f92672">=</span> x.get_double();       <span style="color:#75715e">// get value of double type
</span><span style="color:#75715e"></span>
Json x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world&#34;</span>;          <span style="color:#75715e">// string type
</span><span style="color:#75715e"></span>Json <span style="color:#a6e22e">x</span>(s, n);                    <span style="color:#75715e">// string type (const char* s, size_t n)
</span><span style="color:#75715e"></span>x.is_string();                   <span style="color:#75715e">// determine if it is a string type
</span><span style="color:#75715e"></span>x.size();                        <span style="color:#75715e">// returns the length of the string
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> s <span style="color:#f92672">=</span> x.get_string();  <span style="color:#75715e">// returns pointer to a null-terminated string
</span></code></pre></div><h3 id="132-array-type">13.2 Array type</h3>
<p><code>array</code> is an array type that can store any type of Json object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x <span style="color:#f92672">=</span> json<span style="color:#f92672">::</span>array();      <span style="color:#75715e">// create an empty array, different from null
</span><span style="color:#75715e"></span>x.is_array();                <span style="color:#75715e">// determine if it is an array
</span><span style="color:#75715e"></span>x.size();                    <span style="color:#75715e">// returns the number of elements in the array
</span><span style="color:#75715e"></span>x.empty();                   <span style="color:#75715e">// determine if the array is empty
</span><span style="color:#75715e"></span>
Json x;                      <span style="color:#75715e">// null, becomes array type after push_back is called
</span><span style="color:#75715e"></span>x.push_back(false);          <span style="color:#75715e">// add a value of type bool
</span><span style="color:#75715e"></span>x.push_back(<span style="color:#ae81ff">1</span>);              <span style="color:#75715e">// add a value of type int
</span><span style="color:#75715e"></span>x.push_back(<span style="color:#ae81ff">3.14</span>);           <span style="color:#75715e">// add a value of type double
</span><span style="color:#75715e"></span>x.push_back(<span style="color:#e6db74">&#34;hello&#34;</span>);        <span style="color:#75715e">// add a value of type string
</span><span style="color:#75715e"></span>x.push_back(x);              <span style="color:#75715e">// add a value of type array
</span><span style="color:#75715e"></span>x.push_back(obj);            <span style="color:#75715e">// add a value of type object
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// access members of array
</span><span style="color:#75715e"></span>x[<span style="color:#ae81ff">0</span>].get_bool();
x[<span style="color:#ae81ff">1</span>].get_int();

<span style="color:#75715e">// traverse the array
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (uint32 i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> x.size(); <span style="color:#f92672">++</span>i) {
    Json<span style="color:#f92672">&amp;</span> v <span style="color:#f92672">=</span> x[i];
}
</code></pre></div><h3 id="133-object-type">13.3 Object type</h3>
<p>The <code>object</code> type is stored internally in the form of key-value. The value can be any type of Json object. The key has the following restrictions:</p>
<ul>
<li>key must be a C-style string ending in <code>'\0'</code>.</li>
<li>The key cannot contain double quotes <code>&quot;</code>.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x <span style="color:#f92672">=</span> json<span style="color:#f92672">::</span>object();       <span style="color:#75715e">// create an empty object, different from null
</span><span style="color:#75715e"></span>x.is_object();                 <span style="color:#75715e">// determine if it is object type
</span><span style="color:#75715e"></span>x.size();                      <span style="color:#75715e">// returns the number of elements in object
</span><span style="color:#75715e"></span>x.empty();                     <span style="color:#75715e">// determine if object is empty
</span><span style="color:#75715e"></span>
Json x;                        <span style="color:#75715e">// null, becomes object after calling add_member()
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#e6db74">&#34;Bob&#34;</span>);   <span style="color:#75715e">// add string
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;age&#34;</span>, <span style="color:#ae81ff">23</span>);       <span style="color:#75715e">// add int
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;height&#34;</span>, <span style="color:#ae81ff">1.68</span>);  <span style="color:#75715e">// add double
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;array&#34;</span>, array);  <span style="color:#75715e">// add array
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;obj&#34;</span>, obj);      <span style="color:#75715e">// add object
</span><span style="color:#75715e"></span>
x.has_member(<span style="color:#e6db74">&#34;name&#34;</span>);          <span style="color:#75715e">// determine if the member exists
</span><span style="color:#75715e"></span>x[<span style="color:#e6db74">&#34;name&#34;</span>].get_string();        <span style="color:#75715e">// get value of the member
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// return null if the key does not exist
</span><span style="color:#75715e"></span>Json v <span style="color:#f92672">=</span> x.find(<span style="color:#e6db74">&#34;age&#34;</span>);
<span style="color:#66d9ef">if</span> (v.is_int()) v.get_int();

<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(v <span style="color:#f92672">=</span> x.find(<span style="color:#e6db74">&#34;obj&#34;</span>)).is_null()) {
    do_something();
}

<span style="color:#75715e">// traverse the object
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> x.begin(); it <span style="color:#f92672">!=</span> x.end(); <span style="color:#f92672">++</span>it) {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> key <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>key;  <span style="color:#75715e">// key
</span><span style="color:#75715e"></span>    Json<span style="color:#f92672">&amp;</span> v <span style="color:#f92672">=</span> it<span style="color:#f92672">-&gt;</span>value;        <span style="color:#75715e">// value
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="134-json-to-string">13.4 Json to string</h3>
<p>The Json class provides <code>str()</code> and <code>pretty()</code> methods to convert a Json object into a string:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x;
fastring s <span style="color:#f92672">=</span> x.str();     <span style="color:#75715e">// returns a string
</span><span style="color:#75715e"></span>fastring s <span style="color:#f92672">=</span> x.pretty();  <span style="color:#75715e">// returns a pretty string
</span><span style="color:#75715e"></span>
fastream fs;
fs <span style="color:#f92672">&lt;&lt;</span> x;   <span style="color:#75715e">// write json string to fastream
</span><span style="color:#75715e"></span>LOG <span style="color:#f92672">&lt;&lt;</span> x;  <span style="color:#75715e">// write json string to log file
</span></code></pre></div><p>In addition, the Json class also provides a <code>dbg()</code> method to convert Json into a debug string. The long strings inside Json object may be truncated:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x;
fastring s <span style="color:#f92672">=</span> x.dbg();
LOG <span style="color:#f92672">&lt;&lt;</span> x; <span style="color:#75715e">// Actually equivalent to LOG &lt;&lt; x.dbg();
</span></code></pre></div><h3 id="135-string-to-json">13.5 String to json</h3>
<p><code>json::parse()</code> or the <code>parse_from()</code> method in the Json class can convert a string into a Json object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x;
fastring s <span style="color:#f92672">=</span> x.str();

<span style="color:#75715e">// When parse fails, y is null
</span><span style="color:#75715e"></span>Json y <span style="color:#f92672">=</span> json<span style="color:#f92672">::</span>parse(s);
Json y <span style="color:#f92672">=</span> json<span style="color:#f92672">::</span>parse(s.data(), s.size());
y.parse_from(x.str());
</code></pre></div><h3 id="136-object-type-adding-and-finding-members-efficiently">13.6 Object type: adding and finding members efficiently</h3>
<p>For the <code>object</code> type, an internal array is used to store the key-value pairs. This keeps the order in which members are added, but at the same time increases the cost of finding members. <code>operator[]</code> may be slow as it requires to find the member first.</p>
<ul>
<li>
<p>Use <code>add_member</code> instead of <code>operator[]</code> when adding members</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// add members directly to the end without member searching.
</span><span style="color:#75715e"></span>x.add_member(<span style="color:#e6db74">&#34;age&#34;</span>, <span style="color:#ae81ff">23</span>); <span style="color:#75715e">// more efficient than x[&#34;age&#34;] = 23
</span></code></pre></div></li>
<li>
<p>Replace <code>operator[]</code> with <code>find</code> when finding members</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// not so efficient member access with 3 search operations.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (x.has_member(<span style="color:#e6db74">&#34;age&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> x[<span style="color:#e6db74">&#34;age&#34;</span>].is_int()) {
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> x[<span style="color:#e6db74">&#34;age&#34;</span>].get_int();
}
  
<span style="color:#75715e">// using find(), need only one search operation.
</span><span style="color:#75715e"></span>Json v <span style="color:#f92672">=</span> x.find(<span style="color:#e6db74">&#34;age&#34;</span>);
<span style="color:#66d9ef">if</span> (v.is_int()) {
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> v.get_int();
}
</code></pre></div></li>
</ul>
<h3 id="137-special-characters-in-string-types">13.7 Special characters in string types</h3>
<p>The json string internally ends with &lsquo;\0&rsquo; and mustn&rsquo;t contain any binary character.</p>
<p>The json string supports escape characters such as <code>&quot;</code> and <code>\</code>, as well as <code>\r, \n, \t</code>. However, containing these special characters will reduce the performance of <code>json::parse()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Json x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello </span><span style="color:#ae81ff">\r</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>;  <span style="color:#75715e">// ok, the string contains escape characters
</span><span style="color:#75715e"></span>Json x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> world&#34;</span>;  <span style="color:#75715e">// ok, the string contains &#34;
</span><span style="color:#75715e"></span>Json x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> world&#34;</span>;  <span style="color:#75715e">// ok, the string contains \ 
</span></code></pre></div><h2 id="14-time-library-time">14. Time library (time)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/time.h">co/time.h</a>.</p>
<h3 id="141-monotonic-time">14.1 monotonic time</h3>
<p><code>monotonic time</code> is implemented on most platforms as the time since system startup. It is generally used for timing, which is more stable than system time and is not affected by system time.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">int64 us <span style="color:#f92672">=</span> now<span style="color:#f92672">::</span>us(); <span style="color:#75715e">// Microsecond
</span><span style="color:#75715e"></span>int64 ms <span style="color:#f92672">=</span> now<span style="color:#f92672">::</span>ms(); <span style="color:#75715e">// Millisecond
</span></code></pre></div><h3 id="142-time-string-nowstr">14.2 Time string (now::str())</h3>
<p><code>now::str()</code> is based on <code>strftime</code> and returns a string representation of the current system time in the specified format.</p>
<ul>
<li>Function prototype</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// fm: time output format
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">str</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> fm<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%Y-%m-%d %H:%M:%S&#34;</span>);
</code></pre></div><ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fastring s <span style="color:#f92672">=</span> now<span style="color:#f92672">::</span>str();     <span style="color:#75715e">// &#34;2018-08-08 08:08:08&#34;
</span><span style="color:#75715e"></span>fastring s <span style="color:#f92672">=</span> now<span style="color:#f92672">::</span>str(<span style="color:#e6db74">&#34;%Y&#34;</span>); <span style="color:#75715e">// &#34;2028&#34;
</span></code></pre></div><h3 id="143-sleep">14.3 sleep</h3>
<p>The Linux platform supports microsecond-level sleep, but it is difficult to implement on Windows. Therefore, only millisecond, second-level sleep is supported in this library.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sleep<span style="color:#f92672">::</span>ms(<span style="color:#ae81ff">10</span>); <span style="color:#75715e">// sleep for 10 milliseconds
</span><span style="color:#75715e"></span>sleep<span style="color:#f92672">::</span>sec(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">// sleep for 1 second
</span></code></pre></div><h3 id="144-timertimer">14.4 Timer(Timer)</h3>
<p><code>Timer</code> is based on monotonic time. When a Timer object is created, it starts timing.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Timer t;
sleep<span style="color:#f92672">::</span>ms(<span style="color:#ae81ff">10</span>);

int64 us <span style="color:#f92672">=</span> t.us(); <span style="color:#75715e">// Microsecond
</span><span style="color:#75715e"></span>int64 ms <span style="color:#f92672">=</span> t.ms(); <span style="color:#75715e">// Millisecond
</span><span style="color:#75715e"></span>
t.restart();       <span style="color:#75715e">// Restart timing
</span></code></pre></div><h2 id="15-thread-library-thread">15. Thread library (thread)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/thread.h">co/thread.h</a>.</p>
<h3 id="151-mutex">15.1 Mutex</h3>
<p><code>Mutex</code> is a mutex commonly used in multi-threaded programming. At the same time, at most one thread owns the lock, and other threads must wait for the lock to be released.</p>
<p>There is also a kind of read-write lock, which allows multiple threads to read at the same time, but at most only one thread can write. In practical applications, its performance is poor, so this library has removed the read-write lock.</p>
<p>Corresponding to <code>Mutex</code>, there is a<code> MutexGuard</code> class for automatic acquisition and release of mutex locks.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Mutex m;
m.lock();         <span style="color:#75715e">// Acquire the lock
</span><span style="color:#75715e"></span>m.unlock();       <span style="color:#75715e">// Release the lock
</span><span style="color:#75715e"></span>m.try_lock();     <span style="color:#75715e">// Acquire the lock
</span><span style="color:#75715e"></span>
MutexGuard <span style="color:#a6e22e">g</span>(m);  <span style="color:#75715e">// Call m.lock () in the constructor, 
</span><span style="color:#75715e"></span>                  <span style="color:#75715e">// and call m.unlock () in the destructor.
</span></code></pre></div><h3 id="152-syncevent">15.2 SyncEvent</h3>
<p><code>SyncEvent</code> is a synchronization mechanism commonly used in multi-threaded programming and is suitable for the producer-consumer model.</p>
<ul>
<li>SyncEvent constructor description</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// manual_reset: whether to manually reset the synchronization status of events
</span><span style="color:#75715e">// signaled:     whether the initial state of the event is signaled
</span><span style="color:#75715e"></span>SyncEvent(<span style="color:#66d9ef">bool</span> manual_reset<span style="color:#f92672">=</span>false, <span style="color:#66d9ef">bool</span> signaled<span style="color:#f92672">=</span>false);
</code></pre></div><ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">SyncEvent ev;
ev.wait();                 <span style="color:#75715e">// Thread A, waiting for event synchronization, 
</span><span style="color:#75715e"></span>                           <span style="color:#75715e">// automatically reset the event to unsignaled.
</span><span style="color:#75715e"></span>ev.signal();               <span style="color:#75715e">// Thread B, event synchronization notification
</span><span style="color:#75715e"></span>
SyncEvent <span style="color:#a6e22e">ev</span>(true, false); <span style="color:#75715e">// Enable manual_reset, waiting threads need 
</span><span style="color:#75715e"></span>                           <span style="color:#75715e">// set synchronization status manually 
</span><span style="color:#75715e"></span>ev.wait(<span style="color:#ae81ff">1000</span>);             <span style="color:#75715e">// Thread A, waiting 1000 milliseconds until 
</span><span style="color:#75715e"></span>                           <span style="color:#75715e">//the event is synchronized or timed out
</span><span style="color:#75715e"></span>ev.reset();                <span style="color:#75715e">// Thread A, manually set event status to unsignaled
</span><span style="color:#75715e"></span>ev.signal();               <span style="color:#75715e">// Thread B, event synchronization notification
</span></code></pre></div><h3 id="153-thread">15.3 Thread</h3>
<p>The <code>Thread</code> class is a wrapper around a thread. When a Thread object is created, the thread is started, and when the thread function ends, the thread automatically exits.</p>
<p>In addition to the constructor and destructor, the Thread class provides only two methods:</p>
<ul>
<li>
<p><code>join()</code>, will block and wait for the thread function to finish executing, and then exit the thread.</p>
</li>
<li>
<p><code>detach()</code>, will not block, system resources are automatically released when the thread function ends.</p>
</li>
<li>
<p>Code example</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// start thread
</span><span style="color:#75715e"></span>Thread <span style="color:#a6e22e">x</span>(f);                        <span style="color:#75715e">// void f();
</span><span style="color:#75715e"></span>Thread <span style="color:#a6e22e">x</span>(f, p);                     <span style="color:#75715e">// void f(void*);  void* p;
</span><span style="color:#75715e"></span>Thread <span style="color:#a6e22e">x</span>(<span style="color:#f92672">&amp;</span>T<span style="color:#f92672">::</span>f, <span style="color:#f92672">&amp;</span>t);                <span style="color:#75715e">// void T::f();  T t;
</span><span style="color:#75715e"></span>Thread <span style="color:#a6e22e">x</span>(std<span style="color:#f92672">::</span>bind(f, <span style="color:#ae81ff">7</span>));          <span style="color:#75715e">// void f(int v);
</span><span style="color:#75715e"></span>Thread <span style="color:#a6e22e">x</span>(std<span style="color:#f92672">::</span>bind(<span style="color:#f92672">&amp;</span>T<span style="color:#f92672">::</span>f, <span style="color:#f92672">&amp;</span>t, <span style="color:#ae81ff">7</span>));  <span style="color:#75715e">// void T::f(int v);  T t;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Block, wait for the thread function to finish executing
</span><span style="color:#75715e"></span>x.join();                           

<span style="color:#75715e">// Starts the thread and destroys the Thread object.
</span><span style="color:#75715e">// The thread runs independently of the Thread object.
</span><span style="color:#75715e"></span>Thread(f).detach();
</code></pre></div><h3 id="154-get-the-id-of-the-current-thread">15.4 Get the id of the current thread</h3>
<p><code>current_thread_id ()</code> is used to get the id of the current thread. The thread library uses <a href="https://wiki.osdev.org/Thread_Local_Storage">TLS</a> to save the thread id. Each thread only needs one system call.</p>
<ul>
<li>Notes</li>
</ul>
<p>The Linux glibc has added the <code>gettid</code> system call since <code>2.30</code>. To avoid conflicts, the thread library has removed the earlier provided <code>gettid</code> interface and changed it to<code> current_thread_id</code>.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> current_thread_id();
</code></pre></div><h3 id="155-thread_ptr-based-on-tls">15.5 thread_ptr based on TLS</h3>
<p><code>thread_ptr</code> is similar to<code>std::unique_ptr</code>, but uses the <code>TLS</code> mechanism internally. Each thread sets and has its own ptr.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">T</span> {
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
        cout <span style="color:#f92672">&lt;&lt;</span> current_thread_id() <span style="color:#f92672">&lt;&lt;</span> endl;
    }
};

thread_ptr<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> pt;

<span style="color:#75715e">// Executed in the thread function of thread 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (pt <span style="color:#f92672">==</span> NULL) pt.reset(<span style="color:#66d9ef">new</span> T); 
pt<span style="color:#f92672">-&gt;</span>run();  <span style="color:#75715e">// Print id of thread 1
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Executed in a thread function in thread 2
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (pt <span style="color:#f92672">==</span> NULL) pt.reset(<span style="color:#66d9ef">new</span> T);
pt<span style="color:#f92672">-&gt;</span>run();  <span style="color:#75715e">// Print id of thread 2
</span></code></pre></div><h3 id="156-timed-task-scheduler-tasksched">15.6 Timed task scheduler (TaskSched)</h3>
<p>The <code>TaskSched</code> class is used for scheduling scheduled tasks. All tasks are scheduled by a single thread internally, but tasks can be added from any thread.</p>
<ul>
<li>Methods provided by TaskSched
<ul>
<li>run_in</li>
<li>run_every</li>
<li>run_daily</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// @f: std::function&lt;void()&gt; type function object
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// run f once after n seconds
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run_in</span>(f, n);

<span style="color:#75715e">// run f every n seconds
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run_every</span>(f, n);

<span style="color:#75715e">// run every day at hour:min:sec
</span><span style="color:#75715e">// @hour: 0-23, default is 0
</span><span style="color:#75715e">// @min:  0-59, default is 0
</span><span style="color:#75715e">// @sec:  0-59, default is 0
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run_daily</span>(f, hour<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, min<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, sec<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>);
</code></pre></div><ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">TaskSched s;                      <span style="color:#75715e">// start task scheduling thread
</span><span style="color:#75715e"></span>s.run_in(f, <span style="color:#ae81ff">3</span>);                   <span style="color:#75715e">// run f once after 3 seconds    void f();
</span><span style="color:#75715e"></span>s.run_every(std<span style="color:#f92672">::</span>bind(f, <span style="color:#ae81ff">0</span>), <span style="color:#ae81ff">3</span>);  <span style="color:#75715e">// run f every 3 seconds         void f(int);
</span><span style="color:#75715e"></span>s.run_daily(f);                   <span style="color:#75715e">// run f every day at 00:00:00
</span><span style="color:#75715e"></span>s.run_daily(f, <span style="color:#ae81ff">23</span>);               <span style="color:#75715e">// run f every day at 23:00:00
</span><span style="color:#75715e"></span>s.run_daily(f, <span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">30</span>);           <span style="color:#75715e">// run f every day at 23:30:00
</span><span style="color:#75715e"></span>s.stop();                         <span style="color:#75715e">// stop the task scheduling thread
</span></code></pre></div><h2 id="16-coroutine-library-co">16. Coroutine library (co)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/co.h">co/co.h</a>.</p>
<h3 id="161-basic-concepts">16.1 Basic Concepts</h3>
<ul>
<li>Coroutines are lightweight scheduling units that run in threads.</li>
<li>Coroutines are to threads, similar to threads to processes.</li>
<li>There can be multiple threads in a process and multiple coroutines in a thread.</li>
<li>The thread where the coroutine runs in is generally called the scheduling thread.</li>
<li>When a coroutine occurs such as io blocking or calling sleep, the scheduling thread will suspend the coroutine.</li>
<li>When a coroutine is suspended, the scheduling thread will switch to other coroutines waiting to be executed.</li>
<li>Switching of coroutines is performed in user mode, which is faster than switching between threads.</li>
</ul>
<p>Coroutines are very suitable for writing network programs, and can achieve synchronous programming without asynchronous callbacks, which greatly reduces the programmer&rsquo;s ideological burden.</p>
<p>The <code>co</code> library implements a <a href="https://github.com/golang/go/">golang</a> style coroutine with the following features:</p>
<ul>
<li>Built-in multiple scheduling threads, the default is number of the system CPU cores.</li>
<li>The coroutines in the same scheduling thread share a stack. When a coroutine is suspended, the data on the stack will be copied out, and the data will be copied onto the stack when it is switched back. This method greatly reduces the memory footprint and millions of coroutines can be easily created on a single machine.</li>
<li>There is a flat relationship between coroutines, and new coroutines can be created anywhere (including in coroutines).</li>
</ul>
<p>The co coroutine library is based on <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a>, <a href="https://man.openbsd.org/kqueue.2">kqueue</a>, <a href="https://docs.microsoft.com/en-us/windows/win32/fileio/io-completion-ports">iocp</a> implementation.</p>
<p>The relevant code for context switching in the co coroutine library is taken from <a href="https://github.com/tboox/tbox/">tbox</a> by <a href="https://github.com/waruqi">ruki</a>, and tbox refers to the implementation of <a href="https://www.boost.org/doc/libs/1_70_0/libs/context/doc/html/index.html">boost</a>, thanks here!</p>
<h3 id="162-create-coroutines-go">16.2 Create coroutines (go)</h3>
<p><code>Golang</code> uses the keyword <code>go</code> to create coroutines. Similarly, the co library provides the <code>go()</code> method to create coroutines.</p>
<p>Creating a coroutine is similar to creating a thread. You need to specify a coroutine function. The first parameter of the <code>go()</code> method is the coroutine function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">go</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>f)());
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">go</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>f)(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>), <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p);  <span style="color:#75715e">// p specifies function parameters
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">void</span> go(<span style="color:#66d9ef">void</span> (T<span style="color:#f92672">::*</span>f)(), T<span style="color:#f92672">*</span> p);       <span style="color:#75715e">// p binds a class T object
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">go</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>()<span style="color:#f92672">&gt;&amp;</span> f);
</code></pre></div><p>Actual tests found that creating objects of type <code>std::function</code> is expensive, so go() is especially optimized for function types <code>void f()</code>,<code> void f(void *)</code>, <code>void T::f() </code>. In practical applications, these three types of functions should be used preferentially.</p>
<p>Strictly speaking, the go() method just allocates a <code>callback</code> to a scheduling thread. The actual creation of the coroutine is done by the scheduling thread. However, from the user&rsquo;s point of view, it can be logically considered that go() creates a coroutine and assigns it to a designated scheduling thread, waiting to be executed.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">go(f);                       <span style="color:#75715e">// void f();
</span><span style="color:#75715e"></span>go(f, p);                    <span style="color:#75715e">// void f(void*);   void* p;
</span><span style="color:#75715e"></span>go(<span style="color:#f92672">&amp;</span>T<span style="color:#f92672">::</span>f, p);                <span style="color:#75715e">// void T::f();     T* p;
</span><span style="color:#75715e"></span>go(std<span style="color:#f92672">::</span>bind(f, <span style="color:#ae81ff">7</span>));         <span style="color:#75715e">// void f(int);
</span><span style="color:#75715e"></span>go(std<span style="color:#f92672">::</span>bind(<span style="color:#f92672">&amp;</span>T<span style="color:#f92672">::</span>f, p, <span style="color:#ae81ff">7</span>));  <span style="color:#75715e">// void T::f(int);  T* p;
</span></code></pre></div><h3 id="163-coroutine-api">16.3 coroutine api</h3>
<p>In addition to <code>go()</code>, the co-coroutine library also provides the following apis (located in namespace co):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> ms);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">max_sched_num</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sched_id</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">coroutine_id</span>();
</code></pre></div><ul>
<li>
<p>When <code>sleep</code> is called in a coroutine, the scheduling thread will suspend the coroutine and switch to other coroutines waiting to be executed.</p>
</li>
<li>
<p><code>stop</code> will quit all scheduling threads, usually called before the process exits.</p>
</li>
<li>
<p><code>max_sched_num</code> returns the maximum number of supported scheduling threads. This value is currently the number of system CPU cores.</p>
</li>
<li>
<p><code>sched_id</code> returns the id of the currently scheduled thread, or -1 if the current thread is not a scheduling thread. The value range of id is 0 to <code>max_sched_num-1</code>.</p>
</li>
<li>
<p><code>coroutine_id</code> returns the id of the current coroutine, or -1 if the current thread is not a coroutine. Coroutines in different scheduling threads may have the same id.</p>
</li>
<li>
<p>Code example</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// print the current sched_id and coroutine_id every 1 second
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>() {
    <span style="color:#66d9ef">while</span> (true) {
        co<span style="color:#f92672">::</span>sleep(<span style="color:#ae81ff">1000</span>);
        LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;sid: &#34;</span><span style="color:#f92672">&lt;&lt;</span> co<span style="color:#f92672">::</span>sched_id() <span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34; cid: &#34;</span><span style="color:#f92672">&lt;&lt;</span> co<span style="color:#f92672">::</span>coroutine_id();
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
    flag<span style="color:#f92672">::</span>init(argc, argv);
    log<span style="color:#f92672">::</span>init();

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">32</span>; <span style="color:#f92672">++</span>i) go(f);

    sleep<span style="color:#f92672">::</span>sec(<span style="color:#ae81ff">8</span>); <span style="color:#75715e">// prevent the main thread from exiting immediately
</span><span style="color:#75715e"></span>    co<span style="color:#f92672">::</span>stop();    <span style="color:#75715e">// stop all scheduling threads
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h3 id="164-network-programming">16.4 Network Programming</h3>
<p>co wraps commonly used socket APIs to support general network programming. All these APIs are in the <code>namespace co</code>, which must generally be called in a coroutine. Unlike the native APIs, when IO is blocked or sleep is called for these APIs, the scheduling thread will suspend the current coroutine and switch to other coroutines waiting to be executed.</p>
<h4 id="1641-commonly-used-socket-apis">16.4.1 Commonly used socket APIs</h4>
<p>Co provides some commonly used socket APIs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sock_t <span style="color:#a6e22e">socket</span>(<span style="color:#66d9ef">int</span> domain, <span style="color:#66d9ef">int</span> type, <span style="color:#66d9ef">int</span> proto);
sock_t <span style="color:#a6e22e">tcp_socket</span>(<span style="color:#66d9ef">int</span> af<span style="color:#f92672">=</span>AF_INET); <span style="color:#75715e">// @af: address family, AF_INET, AF_INET6, etc
</span><span style="color:#75715e"></span>sock_t <span style="color:#a6e22e">udp_socket</span>(<span style="color:#66d9ef">int</span> af<span style="color:#f92672">=</span>AF_INET); <span style="color:#75715e">// @af: address family, AF_INET, AF_INET6, etc
</span><span style="color:#75715e"></span>
close shutdown bind listen accept getsockopt
recv recvfrom send sendto connect setsockopt

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">recvn</span>(sock_t fd, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> buf, <span style="color:#66d9ef">int</span> n, <span style="color:#66d9ef">int</span> ms<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>);
</code></pre></div><p>Most of the APIs provided by co are consistent with the native socket APIs, and their usage is almost the same, but there are some slight differences. The instructions are as follows:</p>
<ul>
<li>
<p>The <code>struct sockaddr*</code> in the native api parameters has been replaced with <code>void*</code>, avoiding the trouble of manual conversion.</p>
</li>
<li>
<p><code>socket</code>, <code>tcp_socket</code>, <code>udp_socket</code> are used to create sockets, the created sockets are non-blocking on linux/mac platforms, and [overlapped](<a href="https://support.microsoft.com/en-">https://support.microsoft.com/en-</a> us/help/181611/socket-overlapped-io-versus-blocking-nonblocking-mode) on Windows.</p>
</li>
<li>
<p><code>close</code> can take an additional parameter <code>@ms</code> (default is 0), suspend the current coroutine for several milliseconds, and then close the socket.</p>
</li>
<li>
<p><code>shutdown</code> uses a single character <code>@c</code> to specify the direction, <code>'r'</code> turns off reading, <code>'w'</code> turns off writing, and both reading and writing are turned off by default.</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">shutdown</span>(sock_t fd, <span style="color:#66d9ef">char</span> c<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;b&#39;</span>);
</code></pre></div><ul>
<li>
<p>The socket returned by <code>accept</code> is non-blocking or overlapped, and does not need to be set by the user.</p>
</li>
<li>
<p><code>connect, recv, recvn, recvfrom, send, sendto</code> can take one more parameter specifying the timeout time <code>@ms</code> (default is -1). When a timeout occurs, these APIs return -1 and set errno to <code>ETIMEDOUT</code>.</p>
</li>
<li>
<p><code>recvn</code> receives <code>@n</code> bytes of tcp data, returns n after all received, 0 when disconnected, -1 for other errors.</p>
</li>
<li>
<p><strong>Note:</strong> accept, connect, recv, recvn, recvfrom, send and sendto must be called in coroutines.</p>
</li>
<li>
<p><strong>Special attention:</strong> <code>close</code> and <code>shutdown</code> will not block, but in order to complete the internal cleanup work normally, they must be called in the scheduling thread where the coroutine is located. Generally speaking, when performing recv and send operations in a coroutine, it is best to also call close and shutdown in this coroutine to close the socket.</p>
</li>
</ul>
<p>The above api returns -1 when an error occurs, you can use <code>co::error()</code> to get the error code, and <code>co::strerror()</code> to see the error description.</p>
<h4 id="1642-common-socket-option-settings">16.4.2 Common socket option settings</h4>
<p>co provides the following APIs for setting commonly used socket options:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_reuseaddr</span>(sock_t fd);               <span style="color:#75715e">// Set SO_REUSEADDR
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_tcp_nodelay</span>(sock_t fd);             <span style="color:#75715e">// Set TCP_NODELAY
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_tcp_keepalive</span>(sock_t fd);           <span style="color:#75715e">// Set SO_KEEPALIVE
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_send_buffer_size</span>(sock_t fd, <span style="color:#66d9ef">int</span> n); <span style="color:#75715e">// Set the send buffer size
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_recv_buffer_size</span>(sock_t fd, <span style="color:#66d9ef">int</span> n); <span style="color:#75715e">// Set the receive buffer size
</span></code></pre></div><h4 id="1643-other-apis">16.4.3 Other APIs</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Fill in the ip address
</span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">init_ip_addr</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in</span><span style="color:#f92672">*</span> addr, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ip, <span style="color:#66d9ef">int</span> port);
<span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">init_ip_addr</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in6</span><span style="color:#f92672">*</span> addr, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ip, <span style="color:#66d9ef">int</span> port);

<span style="color:#75715e">// Convert ip address to string
</span><span style="color:#75715e"></span>fastring <span style="color:#a6e22e">ip_str</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in</span><span style="color:#f92672">*</span> addr);
fastring <span style="color:#a6e22e">ip_str</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in6</span><span style="color:#f92672">*</span> addr);

<span style="color:#75715e">// Send a RST, abnormally close the tcp connection, 
</span><span style="color:#75715e">// avoid entering the timedwait state.
</span><span style="color:#75715e">// @ms: The default is 0, suspending the coroutine 
</span><span style="color:#75715e">// for a few milliseconds before send RST.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reset_tcp_socket</span>(sock_t fd, <span style="color:#66d9ef">int</span> ms<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">error</span>();                   <span style="color:#75715e">// return the current error code
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">strerror</span>();        <span style="color:#75715e">// returns the current string error
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">strerror</span>(<span style="color:#66d9ef">int</span> err); <span style="color:#75715e">// returns the string corresponding to @err
</span></code></pre></div><h4 id="1644-hook-system-api">16.4.4 hook system api</h4>
<p>Calling the socket api of the co library in coroutines will not block, but the native socket API called in some third-party libraries may still block. In order to solve this problem, it&rsquo;s necessary to hook related system APIs.</p>
<p>The co library currently supports hooks on the linux/mac platform. The following is a list of hook functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sleep usleep nanosleep

accept accept4 connect close shutdown
read readv recv recvfrom recvmsg
write writev send sendto sendmsg
select poll gethostbyaddr gethostbyname

gethostbyaddr_r gethostbyname2   <span style="color:#75715e">// linux
</span><span style="color:#75715e"></span>gethostbyname_r gethostbyname2_r <span style="color:#75715e">// linux
</span><span style="color:#75715e"></span>
epoll_wait <span style="color:#75715e">// linux
</span><span style="color:#75715e"></span>kevent     <span style="color:#75715e">// mac
</span></code></pre></div><p>Users generally don&rsquo;t need to care about api hooks. If you are interested, you can read the source code implementation of <a href="https://github.com/idealvin/co/tree/master/src/co/impl">hook</a>.</p>
<h4 id="1645-general-network-programming-mode-based-on-coroutines">16.4.5 General network programming mode based on coroutines</h4>
<p>Coroutines can achieve high-performance synchronous network programming. Taking the TCP program as an example, the server generally adopts a mode of one coroutine per connection, creating a new coroutine for each connection, and processing the data on the connection in the coroutine; the client does not need one connection per coroutine, connection pool is generally used instead, and multiple coroutines share the connections in the pool.</p>
<ul>
<li>The general mode of processing connection data on the server side:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">server_fun</span>() {
    <span style="color:#66d9ef">while</span> (true) {
        co<span style="color:#f92672">::</span>recv(...); <span style="color:#75715e">// Receive client request data
</span><span style="color:#75715e"></span>        process(...);  <span style="color:#75715e">// business processing
</span><span style="color:#75715e"></span>        co<span style="color:#f92672">::</span>send(...); <span style="color:#75715e">// send the result to the client
</span><span style="color:#75715e"></span>    }
    co<span style="color:#f92672">::</span>close(...);    <span style="color:#75715e">// close socket
</span><span style="color:#75715e"></span>}
</code></pre></div><ul>
<li>The general mode for the client to handle connection data:</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_fun</span>() {
    co<span style="color:#f92672">::</span>send(...); <span style="color:#75715e">// send request data to the server
</span><span style="color:#75715e"></span>    co<span style="color:#f92672">::</span>recv(...); <span style="color:#75715e">// Receive server response data
</span><span style="color:#75715e"></span>    process(...);  <span style="color:#75715e">// business processing
</span><span style="color:#75715e"></span>}
</code></pre></div><h4 id="1646-example-of-tcp-serverclient-based-on-coroutine">16.4.6 Example of tcp server/client based on coroutine</h4>
<ul>
<li>server code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Connection</span> {
    sock_t fd;   <span style="color:#75715e">// conn fd
</span><span style="color:#75715e"></span>    fastring ip; <span style="color:#75715e">// peer ip
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> port;    <span style="color:#75715e">// peer port
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_new_connection</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p) {
    std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;</span> conn((Connection<span style="color:#f92672">*</span>)p);
    sock_t fd <span style="color:#f92672">=</span> conn<span style="color:#f92672">-&gt;</span>fd;
    co<span style="color:#f92672">::</span>set_tcp_keepalive(fd);
    co<span style="color:#f92672">::</span>set_tcp_nodelay(fd);
    
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span> };

    <span style="color:#66d9ef">while</span> (true) {
        <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> co<span style="color:#f92672">::</span>recv(fd, buf, <span style="color:#ae81ff">4</span>);
        <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {         <span style="color:#75715e">// The client closed the connection
</span><span style="color:#75715e"></span>            co<span style="color:#f92672">::</span>close(fd);    <span style="color:#75715e">// Call close to close the connection normally
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span>;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) { <span style="color:#75715e">// Abnormal error, directly reset the connection
</span><span style="color:#75715e"></span>            co<span style="color:#f92672">::</span>reset_tcp_socket(fd, <span style="color:#ae81ff">1024</span>);
            <span style="color:#66d9ef">break</span>;
        } <span style="color:#66d9ef">else</span> {
            LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;recv &#34;</span><span style="color:#f92672">&lt;&lt;</span> buf;
            LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;send pong&#34;</span>;
            co<span style="color:#f92672">::</span>send(fd, <span style="color:#e6db74">&#34;pong&#34;</span>, <span style="color:#ae81ff">4</span>);
        }
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">server_fun</span>() {
    sock_t fd <span style="color:#f92672">=</span> co<span style="color:#f92672">::</span>tcp_socket();
    co<span style="color:#f92672">::</span>set_reuseaddr(fd);

    sock_t connfd;
    <span style="color:#66d9ef">int</span> addrlen <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(sockaddr_in);
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in</span> addr;
    co<span style="color:#f92672">::</span>init_ip_addr(<span style="color:#f92672">&amp;</span>addr, <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">7788</span>);

    co<span style="color:#f92672">::</span>bind(fd, <span style="color:#f92672">&amp;</span>addr, <span style="color:#66d9ef">sizeof</span>(addr));
    co<span style="color:#f92672">::</span>listen(fd, <span style="color:#ae81ff">1024</span>);

    <span style="color:#66d9ef">while</span> (true) {
        connfd <span style="color:#f92672">=</span> co<span style="color:#f92672">::</span>accept(fd, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>addrlen);
        <span style="color:#66d9ef">if</span> (connfd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">continue</span>;

        Connection<span style="color:#f92672">*</span> conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Connection;
        conn<span style="color:#f92672">-&gt;</span>fd <span style="color:#f92672">=</span> connfd;
        conn<span style="color:#f92672">-&gt;</span>ip <span style="color:#f92672">=</span> co<span style="color:#f92672">::</span>ip_str(<span style="color:#f92672">&amp;</span>addr);
        conn<span style="color:#f92672">-&gt;</span>port <span style="color:#f92672">=</span> ntoh16(addr.sin_port);

        <span style="color:#75715e">// Create a new coroutine for each connection
</span><span style="color:#75715e"></span>        co<span style="color:#f92672">::</span>go(on_new_connection, conn);
    }
}

go(server_fun); <span style="color:#75715e">// Start server coroutine
</span></code></pre></div><ul>
<li>client code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_fun</span>() {
    sock_t fd <span style="color:#f92672">=</span> co<span style="color:#f92672">::</span>tcp_socket();

    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr_in</span> addr;
    co<span style="color:#f92672">::</span>init_ip_addr(<span style="color:#f92672">&amp;</span>addr, <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">7788</span>);

    co<span style="color:#f92672">::</span>connect(fd, <span style="color:#f92672">&amp;</span>addr, <span style="color:#66d9ef">sizeof</span>(addr), <span style="color:#ae81ff">3000</span>);
    co<span style="color:#f92672">::</span>set_tcp_nodelay(fd);

    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span> };

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">7</span>; <span style="color:#f92672">++</span>i) {
        co<span style="color:#f92672">::</span>sleep(<span style="color:#ae81ff">1000</span>);
        LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;send ping&#34;</span>;
        co<span style="color:#f92672">::</span>send(fd, <span style="color:#e6db74">&#34;ping&#34;</span>, <span style="color:#ae81ff">4</span>);
        co<span style="color:#f92672">::</span>recv(fd, buf, <span style="color:#ae81ff">4</span>);
        LOG <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;recv &#34;</span><span style="color:#f92672">&lt;&lt;</span> buf;
    }

    co<span style="color:#f92672">::</span>close(fd);
}

go(client_fun); <span style="color:#75715e">// Start client coroutine
</span></code></pre></div><h3 id="165-coroutine-synchronization-mechanism">16.5 Coroutine synchronization mechanism</h3>
<p>The co library implements a synchronization mechanism similar to threads. Developers familiar with multithreaded programming can easily switch from threads to coroutine programming.</p>
<h4 id="1651-coroutine-lock-comutex">16.5.1 Coroutine lock (co::Mutex)</h4>
<p><code>co::Mutex</code> is similar to <code>Mutex</code> in the thread library, except that it needs to be used in coroutine environment. When the acquisition of the lock fails, the scheduling thread will suspend the current coroutine, and the scheduling thread itself will not block.</p>
<p>In addition, co also provides a <code>co::MutexGuard</code> class, which is used in the same way as <code>MutexGuard</code> in the thread library.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">co<span style="color:#f92672">::</span>Mutex mtx;
<span style="color:#66d9ef">int</span> v <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f1</span>() {
    co<span style="color:#f92672">::</span>MutexGuard g(mtx);
    <span style="color:#f92672">++</span>v;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f2</span>() {
    co<span style="color:#f92672">::</span>MutexGuard g(mtx);
    <span style="color:#f92672">--</span>v;
}

go(f1);
go(f2);
</code></pre></div><h4 id="1652-coroutine-synchronization-event-coevent">16.5.2 Coroutine synchronization event (co::Event)</h4>
<p><code>co::Event</code> is similar to <code>SyncEvent</code> in the thread library, but it needs to be used in coroutine environment. When the <code>wait()</code> method is called, the scheduling thread will suspend the current coroutine, and the scheduling thread itself will not block.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">co<span style="color:#f92672">::</span>Event ev;
<span style="color:#66d9ef">int</span> v <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f1</span>() {
    <span style="color:#75715e">// ev.wait(100); // wait for 100 ms
</span><span style="color:#75715e"></span>    ev.wait();       <span style="color:#75715e">// wait forever
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (v <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) v <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f2</span>() {
    v <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
    ev.signal();
}

go(f1);
go(f2);
</code></pre></div><h3 id="166-coroutine-pool">16.6 Coroutine Pool</h3>
<h4 id="1661-copool">16.6.1 co::Pool</h4>
<p>Threads supports the <code>TLS</code> mechanism, and coroutines can also support a similar <code>CLS</code> mechanism, but considering that millions of coroutines may be created, CLS does not seem to be very efficient. The co library eventually gave up CLS and implemented <code>co::Pool</code> instead:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pool</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    Pool();
    Pool(std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>()<span style="color:#f92672">&gt;&amp;&amp;</span> ccb, <span style="color:#960050;background-color:#1e0010">​​</span>std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&gt;&amp;&amp;</span> dcb, 
         size_t cap<span style="color:#f92672">=</span>(size_t)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);

    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">pop</span>();
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p);

  <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> _p;
};
</code></pre></div><ul>
<li>Constructor</li>
</ul>
<p>The parameters <code>ccb</code> and <code>dcb</code> in the second constructor can be used to create and destroy an element, and <code>cap</code> is used to specify the maximum capacity of the pool. The maximum capacity here is for a single thread. If cap is set to 1024 and there are 8 scheduling threads, the total maximum capacity is actually 8192. Also note that the maximum capacity is only valid when dcb is also specified.</p>
<ul>
<li>pop</li>
</ul>
<p>This method pulls an element from the pool. When the pool is empty, if ccb is set, call ccb to create an element and return; if ccb is not set, return NULL.</p>
<ul>
<li>push</li>
</ul>
<p>This method puts the element back into the pool. If the element is a NULL pointer, it is ignored. If the maximum capacity is exceeded and dcb is specified, call dcb directly to destroy the element without putting it into the pool.</p>
<p>The co::Pool class is coroutine safe. Calling the pop and push methods does not require locking, but it must be called in coroutines.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">co<span style="color:#f92672">::</span>Pool p;

<span style="color:#66d9ef">void</span> f {
    Redis<span style="color:#f92672">*</span> rds <span style="color:#f92672">=</span> (Redis<span style="color:#f92672">*</span>) p.pop();    <span style="color:#75715e">// pull a redis connection from the pool
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (rds <span style="color:#f92672">==</span> NULL) rds <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Redis; <span style="color:#75715e">// create a new redis connection
</span><span style="color:#75715e"></span>
    rds<span style="color:#f92672">-&gt;</span>get(<span style="color:#e6db74">&#34;xx&#34;</span>); <span style="color:#75715e">// call the get method of redis
</span><span style="color:#75715e"></span>    p.push(rds);    <span style="color:#75715e">// put it back
</span><span style="color:#75715e"></span>}

go(f);
</code></pre></div><h4 id="1662-copoolguard">16.6.2 co::PoolGuard</h4>
<p><code>co::PoolGuard</code> is a template class that pulls an element from co::Pool during construction and puts it back when destructuring. In addition, it also overloads <code>operator-&gt;</code>, so that we can use it like a smart pointer.</p>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Specify ccb, ​​dcb for automatic creation and destruction of Redis
</span><span style="color:#75715e"></span>co<span style="color:#f92672">::</span>Pool p(
    []() {<span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>) <span style="color:#66d9ef">new</span> Redis; }, <span style="color:#75715e">// Specify ccb
</span><span style="color:#75715e"></span>    [](<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p) {<span style="color:#66d9ef">delete</span> (Redis<span style="color:#f92672">*</span>)p;}    <span style="color:#75715e">// Specify dcb
</span><span style="color:#75715e"></span>);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>() {
    co<span style="color:#f92672">::</span>PoolGuard<span style="color:#f92672">&lt;</span>Redis<span style="color:#f92672">&gt;</span> rds(p); <span style="color:#75715e">// rds can be regarded as a Redis* pointer
</span><span style="color:#75715e"></span>    rds<span style="color:#f92672">-&gt;</span>get(<span style="color:#e6db74">&#34;xx&#34;</span>);              <span style="color:#75715e">// call the get method of redis
</span><span style="color:#75715e"></span>}

go(f);
</code></pre></div><p>With CLS mechanism, 100k coroutines needs to establish 100k connections. But using Pool, 100k coroutines may only need to share a small number of connections. Pool seems to be more efficient and reasonable than CLS, which is why this library does not support CLS.</p>
<h3 id="167-configuration-items">16.7 Configuration items</h3>
<p>The configuration items supported by the co library are as follows:</p>
<ul>
<li>
<p>co_sched_num</p>
<p>Number of scheduling threads. The default is the number of system CPU cores. In the current implementation, this value must be &lt;= the number of CPU cores.</p>
</li>
<li>
<p>co_stack_size</p>
<p>Coroutine stack size, default is 1MB. Each scheduling thread allocates a stack, and coroutines within the scheduling thread share this stack.</p>
</li>
<li>
<p>co_max_recv_size</p>
<p>The maximum data length that can be received at one time for <code>co::recv</code>. The default is 1M. If it exceeds this size, data will be received in multiple calls of <code>co::recv</code>.</p>
</li>
<li>
<p>co_max_send_size</p>
<p>The maximum data length that can be sent at one time for <code>co::send</code>. The default is 1M. If it exceeds this size, data will be sent in multiple calls of <code>co::send</code>.</p>
</li>
</ul>
<h2 id="17-network-library-so">17. Network library (so)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/so.h">co/so.h</a>.</p>
<p><code>so</code> is a network library based on coroutines, including three modules <code>tcp</code>, <code>http</code>, and <code>rpc</code>.</p>
<h3 id="171-tcp-programming">17.1 TCP programming</h3>
<p><a href="https://github.com/idealvin/co/blob/master/include/co/so/tcp.h">so/tcp</a> module provides two classes <code>tcp::Server</code> and <code>tcp::Client</code>, which support both <code>ipv4</code> and <code>ipv6</code>, and can be used for general TCP programming.</p>
<h4 id="1711-tcpserverhttpsgithubcomidealvincoblobmasterincludecosotcph">17.1.1 <a href="https://github.com/idealvin/co/blob/master/include/co/so/tcp.h">tcp::Server</a></h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">namespace</span> tcp {
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Connection</span> {
    sock_t fd;   <span style="color:#75715e">// conn fd
</span><span style="color:#75715e"></span>    fastring ip; <span style="color:#75715e">// peer ip
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> port;    <span style="color:#75715e">// peer port
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p;     <span style="color:#75715e">// pointer to Server where this connection was accepted
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Server</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    Server(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ip, <span style="color:#66d9ef">int</span> port)
        <span style="color:#f92672">:</span> _ip((ip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span>ip)<span style="color:#f92672">?</span> ip: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>), _port(port) {
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Server() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>() {
        go(<span style="color:#f92672">&amp;</span>Server<span style="color:#f92672">::</span>loop, <span style="color:#66d9ef">this</span>);
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">on_connection</span>(Connection<span style="color:#f92672">*</span> conn) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

  <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    fastring _ip;
    uint32 _port;

  <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">void</span> loop();
};
} <span style="color:#75715e">// tcp
</span></code></pre></div><p><code>tcp::Server</code> creates one coroutine for each connection. Calling the <code>start()</code> method enters the event loop. When a new connection is accepted, a coroutine is created, in which the <code>on_connection()</code> method is called to send or recv data on the connection.</p>
<p>This class can only be used as a base class. User must inherit this class and implement the <code>on_connection()</code> method. Note that the parameter <code>conn</code> is dynamically allocated, remember to delete it after using it.</p>
<p>There is a demo in <code>co/test</code> which implements a simple pingpong server based on <code>tcp::Server</code>. The source code can be found in [pingpong.cc](<a href="https://github.com/idealvin/co/blob/master/test/so">https://github.com/idealvin/co/blob/master/test/so</a> /pingpong.cc).</p>
<h4 id="1712-tcpclienthttpsgithubcomidealvincoblobmasterincludecosotcph">17.1.2 <a href="https://github.com/idealvin/co/blob/master/include/co/so/tcp.h">tcp::Client</a></h4>
<p><code>tcp::Client</code> must be used in coroutine environment. User needs to manually call the <code>connect()</code> method to establish a connection. It is recommended to determine whether the connection is established before calling <code>recv</code>, <code>send</code>. If not, call connect() to establish the connection. It is easy to achieve automatic reconnection in this way.</p>
<p>A <code>tcp::Client</code> corresponds to one connection, do not use the same tcp::Client object in multiple coroutines at the same time. The <code>co</code> coroutine library theoretically supports two coroutines using one connection at the same time, one recv, and one send, but it is not recommended to do so. The standard approach is that both recv and send are done in the same coroutine.</p>
<p>There is no need to create a connection for each coroutine. The recommended method is to put <code>tcp::Client</code> in <code>co::Pool</code>, and multiple coroutines share the connections in the pool. For each coroutine, a connection is taken from the pool when needed, and then put it back after use. This method can reduce the number of connections.</p>
<p>For the specific usage of <code>tcp::Client</code>, you can refer to <code>client_fun()</code> in <a href="https://github.com/idealvin/co/blob/master/test/so/pingpong.cc">pingpong.cc</a>. In addition you can refer to <a href="https://github.com/idealvin/co/blob/master/include/co/so/http.h">http::Client</a> and [rpc::Client](<a href="https://github.com">https://github.com</a> /idealvin/co/blob/master/src/so/rpc.cc).</p>
<h3 id="172-http-programming">17.2 HTTP Programming</h3>
<p><a href="https://github.com/idealvin/co/blob/master/include/co/so/http.h">so/http</a> module implements the <code>http::Server</code> and <code>http::Client</code> class based on <code>so/tcp</code> module, and it also provides a <code>so::easy()</code> method for quickly creating a static web server.</p>
<h4 id="1721-implement-a-simple-http-server">17.2.1 Implement a simple http server</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">http<span style="color:#f92672">::</span>Server serv(<span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, <span style="color:#ae81ff">80</span>);

serv.on_req(
    [](<span style="color:#66d9ef">const</span> http<span style="color:#f92672">::</span>Req<span style="color:#f92672">&amp;</span> req, http<span style="color:#f92672">::</span>Res<span style="color:#f92672">&amp;</span> res) {
        <span style="color:#66d9ef">if</span> (req.is_method_get()) {
            <span style="color:#66d9ef">if</span> (req.url() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/hello&#34;</span>) {
                res.set_status(<span style="color:#ae81ff">200</span>);
                res.set_body(<span style="color:#e6db74">&#34;hello world&#34;</span>);
            } <span style="color:#66d9ef">else</span> {
                res.set_status(<span style="color:#ae81ff">404</span>);
            }
        } <span style="color:#66d9ef">else</span> {
            res.set_status(<span style="color:#ae81ff">501</span>);
        }
    }
);

serv.start();
</code></pre></div><p>User only needs to specify the ip and port, call the <code>on_req()</code> method to register a callback for handling HTTP requests, and then the <code>start()</code> method can be called to start the server.</p>
<p><code>co/test</code> provides a simple <a href="https://github.com/idealvin/co/blob/master/test/so/http_serv.cc">demo</a>, you can build and run it as follow:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake -b http_serv
xmake r http_serv
</code></pre></div><p>After starting the http server, you can enter <code>127.0.0.1/hello</code> in the address bar of the browser to see the result.</p>
<h4 id="1722-implement-a-static-web-server">17.2.2 Implement a static web server</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/flag.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/log.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/so.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
DEF_string(d, <span style="color:#e6db74">&#34;.&#34;</span>, <span style="color:#e6db74">&#34;root dir&#34;</span>); <span style="color:#75715e">// Specify the root directory of the web server
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
    flag<span style="color:#f92672">::</span>init(argc, argv);
    log<span style="color:#f92672">::</span>init();

    so<span style="color:#f92672">::</span>easy(FLG_d.c_str()); <span style="color:#75715e">// mum never have to worry again
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Readers can build <a href="https://github.com/idealvin/co/blob/master/test/so/easy.cc">easy.cc</a> in <code>co/test</code> and run the web server as follow:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake -b easy
xmake r easy -d xxx <span style="color:#75715e"># xxx as the root directory of the web server</span>
</code></pre></div><h4 id="1723-usage-of-http-client">17.2.3 Usage of http client</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">http<span style="color:#f92672">::</span>Client cli(<span style="color:#e6db74">&#34;www.xxx.com&#34;</span>, <span style="color:#ae81ff">80</span>);
http<span style="color:#f92672">::</span>Req req;
http<span style="color:#f92672">::</span>Res res;

req.set_method_get();
req.set_url(<span style="color:#e6db74">&#34;/&#34;</span>);
cli.call(req, res); <span style="color:#75715e">// Get the homepage of www.xxx.com
</span><span style="color:#75715e"></span>
fastring s <span style="color:#f92672">=</span> res.body();
</code></pre></div><p>In the above code, users can precisely control various details with the <code>http::Req</code> and <code>http::Res</code> classes. If you want to be lazy, you can also write as the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">http<span style="color:#f92672">::</span>Client cli(<span style="color:#e6db74">&#34;www.xxx.com&#34;</span>, <span style="color:#ae81ff">80</span>);
fastring s <span style="color:#f92672">=</span> cli.get(<span style="color:#e6db74">&#34;/&#34;</span>);
fastring x <span style="color:#f92672">=</span> cli.post(<span style="color:#e6db74">&#34;/url&#34;</span>, <span style="color:#e6db74">&#34;body&#34;</span>);
</code></pre></div><p><code>http::Client</code> inherits from <code>tcp::Client</code> and must be used in coroutines. It will automatically establish the connection in the <code>call()</code> method, users needn&rsquo;t call <code>connect()</code> manually.</p>
<p><code>co/test</code> provides a simple <a href="https://github.com/idealvin/co/blob/master/test/so/http_cli.cc">demo</a>, build and run it as follow:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake -b http_cli
xmake r http_cli -ip<span style="color:#f92672">=</span>github.com -port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</code></pre></div><h4 id="1724-configuration-items">17.2.4 Configuration items</h4>
<ul>
<li>
<p>http_max_header_size</p>
<p>Specify the maximum length of the http header part. The default is <code>4k</code>.</p>
</li>
<li>
<p>http_max_body_size</p>
<p>Specify the maximum length of the http body part. The default is <code>8M</code>.</p>
</li>
<li>
<p>http_recv_timeout</p>
<p>Specify the timeout time for http recv, in milliseconds. The default is <code>1024 ms</code>.</p>
</li>
<li>
<p>http_send_timeout</p>
<p>Specify the timeout time for http send, in milliseconds. The default is <code>1024 ms</code>.</p>
</li>
<li>
<p>http_conn_timeout</p>
<p>Specify the timeout time for http connect, in milliseconds. The default is <code>3000 ms</code>.</p>
</li>
<li>
<p>http_conn_idle_sec</p>
<p>Specify the timeout time for idle connections, in seconds. The default is <code>180</code> seconds.</p>
</li>
<li>
<p>http_max_idle_conn</p>
<p>Specify the maximum number of idle connections for http server. The default is <code>128</code>.</p>
</li>
<li>
<p>http_log</p>
<p>http log switch, the default is <code>true</code>. (Note that the log only prints the header of http)</p>
</li>
</ul>
<h3 id="173-rpc-framework">17.3 rpc framework</h3>
<p><a href="https://github.com/idealvin/co/blob/master/include/co/so/rpc.h">so/rpc</a> module implements an rpc framework based on <code>so/tcp</code>. It uses <code>tcp/json</code> as the transmission protocol internally. Simple tests show that single-threaded qps can reach <code>120k+</code>. Compared with struct-based binary protocols, json has at least the following advantages:</p>
<ul>
<li>It&rsquo;s easy to capture the package to see the transmitted json object, which is convenient for debugging.</li>
<li>The rpc call directly transmits the json object without defining various structures, which greatly reduces the amount of codes.</li>
<li>The rpc call parameters have the same form, fixed to <code>(const Json&amp; req, Json&amp; res)</code>, it is easy to generate code automatically.</li>
<li>A general rpc client can be implemented, no need to generate different client codes for different rpc server.</li>
</ul>
<h4 id="1731-introduction-to-rpc-server-interface">17.3.1 Introduction to rpc server interface</h4>
<p>The interface of the rpc server is very simple:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">namespace</span> rpc {
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Service</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Service() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// business processing
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Server</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Server() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;

    <span style="color:#75715e">// start rpc server coroutine
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;               

    <span style="color:#75715e">// Service must be added before start()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_service</span>(Service<span style="color:#f92672">*</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; 
};

<span style="color:#75715e">// Create an rpc server, if passwd is not empty, authentication is 
</span><span style="color:#75715e">// required for every new client connection.
</span><span style="color:#75715e"></span>Server<span style="color:#f92672">*</span> <span style="color:#a6e22e">new_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ip, <span style="color:#66d9ef">int</span> port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> passwd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>);
} <span style="color:#75715e">// rpc
</span></code></pre></div><p><code>rpc::Server</code> receives client connections, creates a new coroutine for each connection, the new coroutine receives client requests, and then synchronously calls the <code>process()</code> method provided by <code>rpc::Service</code> to process the request, and finally send the results back to the client.</p>
<p>For specific business processing, you need to inherit <code>rpc::Service</code> and implement the <code>process()</code> method. In fact, the code of <code>process()</code> is automatically generated, and users only need to implement the specific rpc calling method.</p>
<h4 id="1732-introduction-to-rpc-proto-file">17.3.2 Introduction to rpc proto file</h4>
<p>Here is a simple proto file <code>hello_world.proto</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// # or // for comments
</span><span style="color:#75715e"></span>package xx <span style="color:#75715e">// namespace xx
</span><span style="color:#75715e"></span>
service HelloWorld {
    hello,
    world,
}

hello.req {
    <span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;hello&#34;</span>
}

hello.res {
    <span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;hello&#34;</span>,
    <span style="color:#e6db74">&#34;err&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
    <span style="color:#e6db74">&#34;errmsg&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;200 ok&#34;</span>
}

world.req {
    <span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;world&#34;</span>
}

world.res {
    <span style="color:#e6db74">&#34;method&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;world&#34;</span>,
    <span style="color:#e6db74">&#34;err&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>,
    <span style="color:#e6db74">&#34;errmsg&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;200 ok&#34;</span>
}
</code></pre></div><p><code>package xx</code> means to generate code into the namespace <code>xx</code>. You can also use <code>package xx.yy.zz</code> to generate nested namespaces.</p>
<p><code>service HelloWorld</code> defines a service class that extends <code>rpc::Service</code>. <code>Hello, world</code> are two rpc methods it provides.</p>
<p><code>hello.req, hello.res, world.req, world.res</code> are examples of request parameters and response results, which are not needed for generating code.</p>
<ul>
<li>Note that only one service can be defined in a proto file.</li>
</ul>
<h4 id="1733-rpc-code-generator">17.3.3 rpc code generator</h4>
<p>See <a href="https://github.com/idealvin/co/tree/master/gen">co/gen</a> for souces of the code generator.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake -b gen           <span style="color:#75715e"># build gen</span>
gen hello_world.proto  <span style="color:#75715e"># generator code of the rpc framework</span>
</code></pre></div><p>Here is the generated C++ header <code>hello_world.h</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#pragma once
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/so/rpc.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;co/hash.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unordered_map&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">namespace</span> xx {

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloWorld</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rpc<span style="color:#f92672">::</span>Service {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">void</span> (HelloWorld<span style="color:#f92672">::*</span>Fun)(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span>, Json<span style="color:#f92672">&amp;</span>);

    HelloWorld() {
        _methods[hash64(<span style="color:#e6db74">&#34;ping&#34;</span>)] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>HelloWorld<span style="color:#f92672">::</span>ping;
        _methods[hash64(<span style="color:#e6db74">&#34;hello&#34;</span>)] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>HelloWorld<span style="color:#f92672">::</span>hello;
        _methods[hash64(<span style="color:#e6db74">&#34;world&#34;</span>)] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>HelloWorld<span style="color:#f92672">::</span>world;
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>HelloWorld() {}

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) {
        Json<span style="color:#f92672">&amp;</span> method <span style="color:#f92672">=</span> req[<span style="color:#e6db74">&#34;method&#34;</span>];
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>method.is_string()) {
            res.add_member(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#ae81ff">400</span>);
            res.add_member(<span style="color:#e6db74">&#34;errmsg&#34;</span>, <span style="color:#e6db74">&#34;400 req has no method&#34;</span>);
            <span style="color:#66d9ef">return</span>;
        }

        <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> _methods.find(hash64(method.get_string(), method.size()));
        <span style="color:#66d9ef">if</span> (it <span style="color:#f92672">==</span> _methods.end()) {
            res.add_member(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#ae81ff">404</span>);
            res.add_member(<span style="color:#e6db74">&#34;errmsg&#34;</span>, <span style="color:#e6db74">&#34;404 method not found&#34;</span>);
            <span style="color:#66d9ef">return</span>;
        }

        (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;*</span>it<span style="color:#f92672">-&gt;</span>second)(req, res);
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ping</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) {
        res.add_member(<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;ping&#34;</span>);
        res.add_member(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#ae81ff">200</span>);
        res.add_member(<span style="color:#e6db74">&#34;errmsg&#34;</span>, <span style="color:#e6db74">&#34;pong&#34;</span>);
    }
    
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hello</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">world</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

  <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    std<span style="color:#f92672">::</span>unordered_map<span style="color:#f92672">&lt;</span>uint64, Fun<span style="color:#f92672">&gt;</span> _methods;
};

} <span style="color:#75715e">// xx
</span></code></pre></div><p>You can see that <code>HelloWrold</code>'s constructor has registered the hello, world method to the internal map, and the <code>process()</code> method finds and calls the corresponding rpc method according to the <code>method</code> field in rpc request. Users only need to extend the <code>HelloWorld</code> class and implement the hello, world methods for specific business processing. Keep in mind that these methods may be called in different threads, and pay attention to thread safety in the implementations.</p>
<p>If you need to connect to other network services internally in the business process method, you may use coroutine-safe <code>co::Pool</code> to manage network connections.</p>
<p>The generated header file can be directly placed where the server code is located, as the client does not need it at all. The client only refers to the req/res definition in the proto file, which is enough for constructing req to make rpc calls.</p>
<h4 id="1734-implement-rpc-server">17.3.4 implement rpc server</h4>
<p>The following example code <code>hello_world.cc</code> gives a simple implementation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;hello_world.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">namespace</span> xx {

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloWorldImpl</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> HelloWorld {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    HelloWorldImpl() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;
    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>HelloWorldImpl() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hello</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) {
        res.add_member(<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>);
        res.add_member(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#ae81ff">200</span>);
        res.add_member(<span style="color:#e6db74">&#34;errmsg&#34;</span>, <span style="color:#e6db74">&#34;200 ok&#34;</span>);
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">world</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) {
        res.add_member(<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;world&#34;</span>);
        res.add_member(<span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#ae81ff">200</span>);
        res.add_member(<span style="color:#e6db74">&#34;errmsg&#34;</span>, <span style="color:#e6db74">&#34;200 ok&#34;</span>);
    }
};

} <span style="color:#75715e">// xx
</span></code></pre></div><p>Once implements the above business method, you can start the rpc server like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">rpc<span style="color:#f92672">::</span>Server<span style="color:#f92672">*</span> server <span style="color:#f92672">=</span> rpc<span style="color:#f92672">::</span>new_server(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">7788</span>, <span style="color:#e6db74">&#34;passwd&#34;</span>);
server<span style="color:#f92672">-&gt;</span>add_service(<span style="color:#66d9ef">new</span> xx<span style="color:#f92672">::</span>HelloWorldImpl);
server<span style="color:#f92672">-&gt;</span>start();
</code></pre></div><p>Note that calling the <code>start()</code> method will create a coroutine, and the server runs in the coroutine. Preventing the main thread from exiting is something the user needs to care about.</p>
<h4 id="1735-rpc-client">17.3.5 rpc client</h4>
<p>The interface of the rpc client is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Client</span> {
  <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>Client() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ping</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// send a heartbeat
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">call</span>(<span style="color:#66d9ef">const</span> Json<span style="color:#f92672">&amp;</span> req, Json<span style="color:#f92672">&amp;</span> res) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
};

Client<span style="color:#f92672">*</span> <span style="color:#a6e22e">new_client</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ip, <span style="color:#66d9ef">int</span> port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> passwd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>);
} <span style="color:#75715e">// rpc
</span></code></pre></div><p><code>rpc::new_client()</code> creates an rpc client. If the server has set a password, the client needs to bring the password for authentication.</p>
<p>The <code>call()</code> method initiates an rpc call. Different rpc requests can be identified with the method field in req.</p>
<p>The <code>ping()</code> method is for sending heartbeats to the server.</p>
<ul>
<li>Notes
<ul>
<li>When <code>rpc::Client</code> was created, the connection was not established immediately. Instead, the connection was established when the first rpc call was made.</li>
<li><code>delete rpc::Client</code> will close the connection. This operation must be performed within the coroutine.</li>
</ul>
</li>
</ul>
<p>Here is a simple rpc client example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_fun</span>() {
    rpc<span style="color:#f92672">::</span>Client<span style="color:#f92672">*</span> c <span style="color:#f92672">=</span> rpc<span style="color:#f92672">::</span>new_client(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">7788</span>, <span style="color:#e6db74">&#34;passwd&#34;</span>);

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10000</span>; <span style="color:#f92672">++</span>i) {
        Json req, res;
        req.add_member(<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>);
        c<span style="color:#f92672">-&gt;</span>call(req, res); <span style="color:#75715e">// call the hello method
</span><span style="color:#75715e"></span>    }

    <span style="color:#66d9ef">delete</span> c; <span style="color:#75715e">// delete in the coroutine to close the connection safely
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span> (<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
    go(client_fun); <span style="color:#75715e">// create coroutine
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) sleep<span style="color:#f92672">::</span>sec(<span style="color:#ae81ff">7</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Note that one <code>rpc::Client</code> corresponds to one connection. Do not use the same rpc::Client in multiple threads. In a multi-threaded environment, you can use <code>co::Pool</code> to manage client connections. Here is an example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">co<span style="color:#f92672">::</span>Pool p(
    std<span style="color:#f92672">::</span>bind(<span style="color:#f92672">&amp;</span>rpc<span style="color:#f92672">::</span>new_client, <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">7788</span>, <span style="color:#e6db74">&#34;passwd&#34;</span>),
    [](<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p) { <span style="color:#66d9ef">delete</span> (rpc<span style="color:#f92672">::</span>Client<span style="color:#f92672">*</span>) p; }
);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_fun</span>() {
    co<span style="color:#f92672">::</span>PoolGuard<span style="color:#f92672">&lt;</span>rpc<span style="color:#f92672">::</span>Client<span style="color:#f92672">&gt;</span> c(p);

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; <span style="color:#f92672">++</span>i) {
        Json req, res;
        req.add_member(<span style="color:#e6db74">&#34;method&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>);
        c<span style="color:#f92672">-&gt;</span>call(req, res); <span style="color:#75715e">// call the hello method
</span><span style="color:#75715e"></span>    }
}

<span style="color:#75715e">// create 8 coroutines
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>; <span style="color:#f92672">++</span>i) {
    go(client_fun);
}
</code></pre></div><h4 id="1736-configuration-items">17.3.6 Configuration Items</h4>
<p>The rpc library supports the following configuration items:</p>
<ul>
<li>
<p>rpc_max_msg_size</p>
<p>The maximum length of the rpc message. The default is <code>8M</code>.</p>
</li>
<li>
<p>rpc_recv_timeout</p>
<p>rpc timeout time for receiving data, unit is millisecond, default is <code>1024</code> milliseconds.</p>
</li>
<li>
<p>rpc_send_timeout</p>
<p>rpc timeout time for sending data, unit is millisecond, default is <code>1024</code> milliseconds.</p>
</li>
<li>
<p>rpc_conn_timeout</p>
<p>rpc connection timeout time in milliseconds. The default is <code>3000</code> milliseconds.</p>
</li>
<li>
<p>rpc_conn_idle_sec</p>
<p>The time during which rpc keeps idle connections in seconds. The default is <code>180</code> seconds. If a connection does not receive any data after this time, the server may close the connection.</p>
</li>
<li>
<p>rpc_max_idle_conn</p>
<p>The maximum number of idle connections. The default is <code>128</code>. If the number of connections exceeds this value, the server will close some idle connections (connections that have not received data within rpc_conn_idle_sec time).</p>
</li>
<li>
<p>rpc_log</p>
<p>Whether to enable rpc logs. The default is <code>true</code>.</p>
</li>
</ul>
<h2 id="18-hash-library">18. Hash library</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/hash.h">co/hash.h</a>.</p>
<p>The <code>hash</code> library provides the following functions:</p>
<ul>
<li>
<p>murmur_hash</p>
<p>Return a value of type <code>size_t</code>. This hash function is used in the implementation of <code>std::hash&lt;fastring&gt;</code>.</p>
</li>
<li>
<p>hash64</p>
<p>Calculates a 64-bit hash value. The murmur 2 hash algorithm is used internally.</p>
</li>
<li>
<p>hash32</p>
<p>Calculates a 32-bit hash value. The murmur 2 hash algorithm is used internally on 32 bit platform. For 64 bit platform, return the lower 32 bits of <code>hash64</code> directly.</p>
</li>
<li>
<p>md5sum</p>
<p>Calculates the md5 value of a string or a specified length of data and returns a 32-byte string.</p>
</li>
<li>
<p>crc16</p>
<p>Calculate the crc16 value of a string or a specified length of data, the implementation is taken from <a href="https://github.com/antirez/redis/">redis</a>.</p>
</li>
<li>
<p>base64_encode</p>
<p>Base64 encoding, <code>\r, \n</code> are not added, it is not necessary in practical.</p>
</li>
<li>
<p>base64_decode</p>
<p>Base64 decoding, throws <code>const char*</code> type exception when decoding fails.</p>
</li>
<li>
<p>Code example</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">uint64 h <span style="color:#f92672">=</span> hash64(s);                <span style="color:#75715e">// hash of string s
</span><span style="color:#75715e"></span>uint64 h <span style="color:#f92672">=</span> hash64(s, n);             <span style="color:#75715e">// hash of the specified length of data
</span><span style="color:#75715e"></span>uint32 h <span style="color:#f92672">=</span> hash32(s);                <span style="color:#75715e">// 32-bit hash of string s
</span><span style="color:#75715e"></span>  
fastring s <span style="color:#f92672">=</span> md5sum(<span style="color:#e6db74">&#34;hello world&#34;</span>);  <span style="color:#75715e">// md5 of string, the result is 32 bytes
</span><span style="color:#75715e"></span>uint16 x <span style="color:#f92672">=</span> crc16(<span style="color:#e6db74">&#34;hello world&#34;</span>);     <span style="color:#75715e">// crc16 of string
</span><span style="color:#75715e"></span>  
fastring e <span style="color:#f92672">=</span> base64_encode(s);       <span style="color:#75715e">// base64 encoding
</span><span style="color:#75715e"></span>fastring d <span style="color:#f92672">=</span> base64_decode(e);       <span style="color:#75715e">// base64 decoding
</span></code></pre></div></li>
</ul>
<h2 id="19-path-library">19. Path library</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/path.h">co/path.h</a>.</p>
<p>The <code>path</code> library is ported from <a href="https://github.com/golang/go/blob/master/src/path/path.go">golang</a>. The path separator is assumed to be &lsquo;/&rsquo;.</p>
<ul>
<li>
<p><code>path::clean()</code></p>
<p>Returns the shortest equivalent form of a path. Continuous separators in the path are removed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>clean(<span style="color:#e6db74">&#34;./x//y/&#34;</span>);    <span style="color:#75715e">// return &#34;x/y&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>clean(<span style="color:#e6db74">&#34;./x/..&#34;</span>);     <span style="color:#75715e">// return &#34;.&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>clean(<span style="color:#e6db74">&#34;./x/../..&#34;</span>);  <span style="color:#75715e">// return &#34;..&#34;
</span></code></pre></div></li>
<li>
<p><code>path::join()</code></p>
<p>Splices any number of strings into a complete path, the result was processed by path::clean().</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>join(<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span>, <span style="color:#e6db74">&#34;z&#34;</span>);  <span style="color:#75715e">// return &#34;x/y/z&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>join(<span style="color:#e6db74">&#34;/x/&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span>);     <span style="color:#75715e">// return &#34;/x/y&#34;
</span></code></pre></div></li>
<li>
<p><code>path::split()</code></p>
<p>Divide the path into two parts, dir and file. If the path does not contain a separator, the dir part is empty. The returned result satisfies the property <code>path = dir + file</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;/&#34;</span>);     <span style="color:#75715e">//-&gt; {&#34;/&#34;, &#34;&#34;}
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;/a&#34;</span>);    <span style="color:#75715e">//-&gt; {&#34;/&#34;, &#34;a&#34;}
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>split(<span style="color:#e6db74">&#34;/a/b&#34;</span>);  <span style="color:#75715e">//-&gt; {&#34;/a/&#34;, &#34;b&#34;}
</span></code></pre></div></li>
<li>
<p><code>path::dir()</code></p>
<p>Returns the directory portion of the path, the result was processed by path::clean().</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>dir(<span style="color:#e6db74">&#34;a&#34;</span>);   <span style="color:#75715e">// return &#34;.&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>dir(<span style="color:#e6db74">&#34;a/&#34;</span>);  <span style="color:#75715e">// return &#34;a&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>dir(<span style="color:#e6db74">&#34;/&#34;</span>);   <span style="color:#75715e">// return &#34;/&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>dir(<span style="color:#e6db74">&#34;/a&#34;</span>);  <span style="color:#75715e">// return &#34;/&#34;;
</span></code></pre></div></li>
<li>
<p><code>path::base()</code></p>
<p>Returns the last element of the path.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>base(<span style="color:#e6db74">&#34;&#34;</span>);      <span style="color:#75715e">// return &#34;.&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>base(<span style="color:#e6db74">&#34;/&#34;</span>);     <span style="color:#75715e">// return &#34;/&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>base(<span style="color:#e6db74">&#34;/a/&#34;</span>);   <span style="color:#75715e">// return &#34;a&#34;, ignores the trailing delimiter
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>base(<span style="color:#e6db74">&#34;/a&#34;</span>);    <span style="color:#75715e">// return &#34;a&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>base(<span style="color:#e6db74">&#34;/a/b&#34;</span>);  <span style="color:#75715e">// return &#34;b&#34;
</span></code></pre></div></li>
<li>
<p><code>path::ext()</code></p>
<p>This function returns the extension of the file name in the path.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">path<span style="color:#f92672">::</span>ext(<span style="color:#e6db74">&#34;/a.cc&#34;</span>);   <span style="color:#75715e">// return &#34;.cc&#34;
</span><span style="color:#75715e"></span>path<span style="color:#f92672">::</span>ext(<span style="color:#e6db74">&#34;/a.cc/&#34;</span>);  <span style="color:#75715e">// return &#34;&#34;
</span></code></pre></div></li>
</ul>
<h2 id="20-file-system-operations-fs">20. File System Operations (fs)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/fs.h">co/fs.h</a>.</p>
<p>The <code>fs</code> library minimally implements common file system operations. The path separator for different platforms is recommended to use <code>'/'</code> uniformly.</p>
<h3 id="201-metadata-operations">20.1 Metadata Operations</h3>
<ul>
<li>Code example</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> x <span style="color:#f92672">=</span> fs<span style="color:#f92672">::</span>exists(path);  <span style="color:#75715e">// determine if the file exists
</span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> x <span style="color:#f92672">=</span> fs<span style="color:#f92672">::</span>isdir(path);   <span style="color:#75715e">// determine if the file is a directory
</span><span style="color:#75715e"></span>int64 x <span style="color:#f92672">=</span> fs<span style="color:#f92672">::</span>mtime(path);  <span style="color:#75715e">// get the modification time of the file
</span><span style="color:#75715e"></span>int64 x <span style="color:#f92672">=</span> fs<span style="color:#f92672">::</span>fsize(path);  <span style="color:#75715e">// get the size of the file
</span><span style="color:#75715e"></span>
fs<span style="color:#f92672">::</span>mkdir(<span style="color:#e6db74">&#34;a/b&#34;</span>);           <span style="color:#75715e">// mkdir a/b
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>mkdir(<span style="color:#e6db74">&#34;a/b&#34;</span>, true);     <span style="color:#75715e">// mkdir -p a/b
</span><span style="color:#75715e"></span>
fs<span style="color:#f92672">::</span>remove(<span style="color:#e6db74">&#34;x/x.txt&#34;</span>);      <span style="color:#75715e">// rm x/x.txt
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>remove(<span style="color:#e6db74">&#34;a/b&#34;</span>);          <span style="color:#75715e">// rmdir a/b, delete empty directory
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>remove(<span style="color:#e6db74">&#34;a/b&#34;</span>, true);    <span style="color:#75715e">// rm -rf a/b
</span><span style="color:#75715e"></span>
fs<span style="color:#f92672">::</span>rename(<span style="color:#e6db74">&#34;a/b&#34;</span>, <span style="color:#e6db74">&#34;a/c&#34;</span>);   <span style="color:#75715e">// rename
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>symlink(<span style="color:#e6db74">&#34;/usr&#34;</span>, <span style="color:#e6db74">&#34;x&#34;</span>);   <span style="color:#75715e">// soft link: x -&gt; /usr
</span></code></pre></div><h3 id="202-basic-file-read-and-write-operations">20.2 Basic file read and write operations</h3>
<p>The <code>fs</code> library implements the <code>fs::file</code> class, which supports basic read and write operations on files.</p>
<ul>
<li>
<p>Features of <code>fs::file</code></p>
<ul>
<li>Support <code>r, w, a, m</code> four read and write modes, the first three are consistent with fopen, <code>m</code> is similar to <code>w</code>, but the data of existing files is not cleared.</li>
<li>Does not support caching, read and write files directly.</li>
<li>Support <code>move</code> semantics, you can put the file object directly into the STL container.</li>
</ul>
</li>
<li>
<p>Code example</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fs<span style="color:#f92672">::</span>file f;               <span style="color:#75715e">// f.open() can be called later to open the file
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>file f(<span style="color:#e6db74">&#34;xx&#34;</span>, <span style="color:#e6db74">&#39;r&#39;</span>);    <span style="color:#75715e">// Open the file in read mode
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// automatically close the previously opened file
</span><span style="color:#75715e"></span>f.open(<span style="color:#e6db74">&#34;xx&#34;</span>, <span style="color:#e6db74">&#39;a&#39;</span>);        <span style="color:#75715e">// append write, create if file does not exist
</span><span style="color:#75715e"></span>f.open(<span style="color:#e6db74">&#34;xx&#34;</span>, <span style="color:#e6db74">&#39;w&#39;</span>);        <span style="color:#75715e">// normal write, create if file does not exist, 
</span><span style="color:#75715e"></span>                          <span style="color:#75715e">// and clear the data if the file exists.
</span><span style="color:#75715e"></span>f.open(<span style="color:#e6db74">&#34;xx&#34;</span>, <span style="color:#e6db74">&#39;m&#39;</span>);        <span style="color:#75715e">// modify write, create if file does not exist, 
</span><span style="color:#75715e"></span>                          <span style="color:#75715e">// won&#39;t clear the data if the file exists.
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> (f) f.read(buf, <span style="color:#ae81ff">512</span>);  <span style="color:#75715e">// read up to 512 bytes
</span><span style="color:#75715e"></span>f.write(buf, <span style="color:#ae81ff">32</span>);         <span style="color:#75715e">// write 32 bytes
</span><span style="color:#75715e"></span>f.write(<span style="color:#e6db74">&#34;hello&#34;</span>);         <span style="color:#75715e">// write string
</span><span style="color:#75715e"></span>f.write(<span style="color:#e6db74">&#39;c&#39;</span>);             <span style="color:#75715e">// write a single character
</span><span style="color:#75715e"></span>f.close();                <span style="color:#75715e">// close the file, it will be called in destructor. 
</span></code></pre></div><h3 id="203-file-stream-fsfstream">20.3 File stream (fs::fstream)</h3>
<p><code>fs::file</code> does not support caching, and the performance of writing small files is poor. For this reason, the <code>fs</code> library also provides the <code>fs::fstream</code> class.</p>
<ul>
<li>
<p>Features of <code>fs::fstream</code></p>
<ul>
<li>For write only, and supports two modes: <code>w, a</code>.</li>
<li>You can customize the cache size. The default is <code>8k</code>.</li>
<li>Supports <code>move</code> semantics, allowing fstream objects to be placed in STL containers.</li>
</ul>
</li>
<li>
<p>Code example</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">fs<span style="color:#f92672">::</span>fstream s;                     <span style="color:#75715e">// default cache is 8k
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>fstream s(<span style="color:#ae81ff">4096</span>);               <span style="color:#75715e">// Specify cache as 4k
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>fstream s(<span style="color:#e6db74">&#34;path&#34;</span>, <span style="color:#e6db74">&#39;a&#39;</span>);        <span style="color:#75715e">// append mode, cache defaults to 8k
</span><span style="color:#75715e"></span>fs<span style="color:#f92672">::</span>fstream s(<span style="color:#e6db74">&#34;path&#34;</span>, <span style="color:#e6db74">&#39;w&#39;</span>, <span style="color:#ae81ff">4096</span>);  <span style="color:#75715e">// write mode, specify 4k cache
</span><span style="color:#75715e"></span>
s.open(<span style="color:#e6db74">&#34;path&#34;</span>, <span style="color:#e6db74">&#39;a&#39;</span>);               <span style="color:#75715e">// Open and close the previously opened file
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (s) s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;hello world&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">23</span>;   <span style="color:#75715e">// streaming
</span><span style="color:#75715e"></span>s.append(data, size);              <span style="color:#75715e">// append data of specified length
</span><span style="color:#75715e"></span>s.flush();                         <span style="color:#75715e">// write data from cache to file
</span><span style="color:#75715e"></span>s.close();                         <span style="color:#75715e">// Close the file, it will be called in destructor
</span></code></pre></div><h2 id="21-system-operations-os">21. System operations (os)</h2>
<p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/os.h">co/os.h</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">os<span style="color:#f92672">::</span>homedir();  <span style="color:#75715e">// returns the home directory path
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>cwd();      <span style="color:#75715e">// returns the current working directory path
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>exepath();  <span style="color:#75715e">// returns the current process path
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>exename();  <span style="color:#75715e">// returns the current process name
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>pid();      <span style="color:#75715e">// returns the current process id
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>cpunum();   <span style="color:#75715e">// returns the number of CPU cores
</span><span style="color:#75715e"></span>os<span style="color:#f92672">::</span>daemon();   <span style="color:#75715e">// runs as a daemon, only supports Linux platforms
</span></code></pre></div><h2 id="22-compiling">22. Compiling</h2>
<h3 id="xmake">xmake</h3>
<p><a href="https://github.com/xmake-io/xmake">Xmake</a> is recommended for compiling the <code>CO</code> project.</p>
<ul>
<li>
<p>Compiler</p>
<ul>
<li>Linux: <a href="https://gcc.gnu.org/projects/cxx-status.html#cxx11">gcc 4.8+</a></li>
<li>Mac: <a href="https://clang.llvm.org/cxx_status.html">clang 3.3+</a></li>
<li>Windows: <a href="https://visualstudio.microsoft.com/">vs2015+</a></li>
</ul>
</li>
<li>
<p>Install xmake</p>
<p>For windows, mac and debian/ubuntu, you can directly go to the <a href="https://github.com/xmake-io/xmake/releases">xmake release page</a> to download the installation package. For other systems, please refer to xmake&rsquo;s <a href="https://xmake.io/#/guide/installation">installation instructions</a>.</p>
<p>Xmake disables compilation as root by default on linux. <a href="https://github.com/waruqi">ruki</a> says it is not safe. You can add the following line to <code>~/.bashrc</code> to enable root compilation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">export XMAKE_ROOT<span style="color:#f92672">=</span>y
</code></pre></div></li>
<li>
<p>Quick start</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># All commands are executed in the root directory of co (the same below)</span>
xmake       <span style="color:#75715e"># build libco and gen by default</span>
xmake -a    <span style="color:#75715e"># build all projects (libco, gen, co/test, co/unitest)</span>
</code></pre></div></li>
<li>
<p>Build libco</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake build libco      <span style="color:#75715e"># build libco only</span>
xmake -b libco         <span style="color:#75715e"># the same as above</span>
</code></pre></div></li>
<li>
<p>Build and run unitest code</p>
<p><a href="https://github.com/idealvin/co/tree/master/unitest">co/unitest</a> is unit test code that verifies the correctness of the functionality of the base library.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake build unitest    <span style="color:#75715e"># build can be abbreviated as -b</span>
xmake run unitest -a   <span style="color:#75715e"># run all unit tests</span>
xmake r unitest -a     <span style="color:#75715e"># the same as above</span>
xmake r unitest -os    <span style="color:#75715e"># run unit test os</span>
xmake r unitest -json  <span style="color:#75715e"># run unit test json</span>
</code></pre></div></li>
<li>
<p>Build and run test code</p>
<p><a href="https://github.com/idealvin/co/tree/master/test">co/test</a> contains some test code. You can easily add a <code>xxx.cc</code> source file in the <code>co/test</code> directory, and then execute <code>xmake build xxx</code> to build it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xmake build flag             <span style="color:#75715e"># flag.cc</span>
xmake build log              <span style="color:#75715e"># log.cc</span>
xmake build json             <span style="color:#75715e"># json.cc</span>
xmake build rapidjson        <span style="color:#75715e"># rapidjson.cc</span>
xmake build rpc              <span style="color:#75715e"># rpc.cc</span>
xmake build easy             <span style="color:#75715e"># so/easy.cc</span>
xmake build pingpong         <span style="color:#75715e"># so/pingpong.cc</span>
  
xmake r flag -xz             <span style="color:#75715e"># test flag</span>
xmake r log                  <span style="color:#75715e"># test log</span>
xmake r log -cout            <span style="color:#75715e"># also log to terminal</span>
xmake r log -perf            <span style="color:#75715e"># performance test</span>
xmake r json                 <span style="color:#75715e"># test json</span>
xmake r rapidjson            <span style="color:#75715e"># test rapidjson</span>
xmake r rpc                  <span style="color:#75715e"># start rpc server</span>
xmake r rpc -c               <span style="color:#75715e"># start rpc client</span>
xmake r easy -d xxx          <span style="color:#75715e"># start web server</span>
xmake r pingpong             <span style="color:#75715e"># pingpong server:   127.0.0.1:9988</span>
xmake r pingpong ip<span style="color:#f92672">=</span>::       <span style="color:#75715e"># pingpong server:   :::9988  (ipv6)</span>
xmake r pingpong -c ip<span style="color:#f92672">=</span>::1   <span style="color:#75715e"># pingpong client -&gt; ::1:9988</span>
</code></pre></div></li>
<li>
<p>Build gen</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># It is recommended to put gen in the system directory (e.g. /usr/local/bin/).</span>
xmake build gen
gen hello_world.proto
</code></pre></div><p>Proto file format can refer to <a href="https://github.com/idealvin/co/blob/master/test/__/rpc/hello_world.proto">hello_world.proto</a>.</p>
</li>
<li>
<p>Installation</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Install header files, libco, gen by default.</span>
xmake install -o pkg         <span style="color:#75715e"># package related files to the pkg directory</span>
xmake i -o pkg               <span style="color:#75715e"># the same as above</span>
xmake install -o /usr/local  <span style="color:#75715e"># install to the /usr/local directory</span>
</code></pre></div></li>
</ul>
<h3 id="cmake">cmake</h3>
<p><a href="https://github.com/izhengfan">izhengfan</a> has helped to provide cmake support:</p>
<ul>
<li>Build <code>libco</code> and <code>gen</code> by default.</li>
<li>The library files are in the <code>build/lib</code> directory, and the executable files are in the <code>build/bin</code> directory.</li>
<li>You can use <code>BUILD_ALL</code> to compile all projects.</li>
<li>You can use <code>CMAKE_INSTALL_PREFIX</code> to specify the installation directory.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir build <span style="color:#f92672">&amp;&amp;</span> cd build
cmake ..
cmake .. -DBUILD_ALL<span style="color:#f92672">=</span>ON -DCMAKE_INSTALL_PREFIX<span style="color:#f92672">=</span>pkg
make -j8
make install
</code></pre></div><h2 id="23-donate">23. Donate</h2>
<p>Goto the <a href="https://idealvin.github.io/donate/">Donate</a> page.</p>


  <footer>
  



<nav class="post-nav">
  <ul>
     
    <li>
      <span class="post-nav-prev">&rtrif; 上一篇 &emsp;</span>
      <a href="/coding/2020/07/move_co_docs/">关于更新 CO 参考文档的说明</a>
    </li>
    
    
    <li>
      <span class="post-nav-next">&rtrif; 下一篇 &emsp;</span>
      <a href="/coding/2020/07/co/">C&#43;&#43; 基础库 CO 参考文档 v1.2</a>
    </li>
    
  </ul>
</nav>



<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.6.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.6.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '78371628e00f43aff18e',
    clientSecret: '6905d0b807b7008ea04b420bb9fd9a7f390ec400',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false
  })
  
  gitalk.render('gitalk-container');
</script>



  



<script src="//cdn.bootcss.com/highlight.js/10.1.2/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/10.1.2/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/10.1.2/languages/bash.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">©2018-2020 <a href="/">Alvin Yih</a> | <a href="https://github.com/idealvin">Github</a></div>
  
  </footer>
  
   <div class="cnzz">
<script type="text/javascript">
  document.write(unescape("%3Cspan id='cnzz_stat_icon_1279117347'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279117347%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));
</script>
</div> 
  </article>
  
  </body>
</html>

