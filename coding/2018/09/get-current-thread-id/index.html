<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>高效获取当前线程的 id - Alvin&#39;s blog</title>
    <meta property="og:title" content="高效获取当前线程的 id - Alvin&#39;s blog">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="可以利用微软提供的 api，轻松获取当前线程的 id：
int id = GetCurrentThreadId();   Linux  Linux 平台一般用的是 pthread 线程库，但它并不提供获取线程内部 id 的方法。可以通过系统调用得到当前线程的 id：
#include &amp;lt;unistd.h&amp;gt; // for syscall() #include &amp;hellip;">
      <meta property="og:description" content="可以利用微软提供的 api，轻松获取当前线程的 id：
int id = GetCurrentThreadId();   Linux  Linux 平台一般用的是 pthread 线程库，但它并不提供获取线程内部 id 的方法。可以通过系统调用得到当前线程的 id：
#include &amp;lt;unistd.h&amp;gt; // for syscall() #include &amp;hellip;">
      
    

    
    

    
    <meta property="keywords" content ="thread,thread, id,syscall,GetCurrentThreadId">
    

    
    <link rel="icon" href="/favicon.ico">
    
<link href='/css/code.css' rel='stylesheet' type='text/css' />


    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/custom.css" />    
    
  </head>

  
  <body class="coding">
    <header class="masthead">
      <h1><a href="/" style="border: none;"><img src="/images/logo.jpg" alt="Alvin Yih"></a></h1>



      <nav class="menu">
  <input id="menu-check" type="checkbox" />
  <label id="menu-label" for="menu-check" class="unselectable">
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li>
    <a href="/">主页</a>
  </li>
  
  <li>
    <a href="/about/">关于</a>
  </li>
  
  <li class="active">
    <a href="/coding/">编程</a>
  </li>
  
  <li>
    <a href="/essay/">随笔</a>
  </li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      <h1>高效获取当前线程的 id</h1>

<h3>Alvin
  /  2018-09-28</h3>
<hr>
      </header>





<h2 id="不同平台获取当前线程-id-的方法">不同平台获取当前线程 id 的方法</h2>

<ul>
<li><strong>Windows</strong></li>
</ul>

<p>可以利用微软提供的 api，轻松获取当前线程的 id：</p>

<pre><code class="language-cpp">int id = GetCurrentThreadId();
</code></pre>

<ul>
<li><strong>Linux</strong></li>
</ul>

<p>Linux 平台一般用的是 <a href="https://en.wikipedia.org/wiki/POSIX_Threads">pthread</a> 线程库，但它并不提供获取线程内部 id 的方法。可以通过<a href="https://en.wikipedia.org/wiki/System_call">系统调用</a>得到当前线程的 id：</p>

<pre><code class="language-cpp">#include &lt;unistd.h&gt;       // for syscall()
#include &lt;sys/syscall.h&gt;  // for SYS_xxx definitions

int id = syscall(SYS_gettid);
</code></pre>

<ul>
<li><strong>Mac</strong></li>
</ul>

<p>Mac 平台也可以用 <code>syscall</code> 获取当前线程的 id，与 Linux 稍有区别：</p>

<pre><code class="language-cpp">#include &lt;unistd.h&gt;       // for syscall()
#include &lt;sys/syscall.h&gt;  // for SYS_xxx definitions

int id = syscall(SYS_thread_selfid); // for mac os x
</code></pre>

<p>不过在 mac os x 10.12 之后，syscall 被标记为 <strong>deprecated</strong>，所以最好还是用下面的方法取代 syscall：</p>

<pre><code class="language-cpp">#include &lt;pthread.h&gt;

uint64_t id;
pthread_threadid_np(0, &amp;id); // non-posix, supported by BSD
</code></pre>

<h2 id="基于-tls-的优化">基于 TLS 的优化</h2>

<p>系统调用会在用户态与内核态之间来回切换，相对比较耗时。为了避免频繁的系统调用，可以用 <a href="https://en.wikipedia.org/wiki/Thread-local_storage">TLS</a> 优化，每个线程只需一次系统调用：</p>

<pre><code class="language-cpp">inline int tls_get_tid() {
    static __thread int id = 0;
    if (id != 0) return id;
    id = syscall(SYS_gettid);
    return id;
}
</code></pre>

<p>下面是一段简单的测试代码：</p>

<pre><code class="language-cpp">inline int sys_get_tid() {
    return syscall(SYS_gettid);
}

void fsys() {
    int v = 0;
    Timer t;
    for (int i = 0; i &lt; 1000000; i++) {
        v = sys_get_tid();
    }

    int64 us = t.us();
    cout &lt;&lt; &quot;fsys use &quot; &lt;&lt; us &lt;&lt; &quot;us&quot; &lt;&lt; &quot;  id: &quot; &lt;&lt; v &lt;&lt; endl;
}

void ftls() {
    int v = 0;
    Timer t;
    for (int i = 0; i &lt; 1000000; i++) {
        v = tls_get_tid();
    }

    int64 us = t.us();
    cout &lt;&lt; &quot;ftls use &quot; &lt;&lt; us &lt;&lt; &quot;us&quot; &lt;&lt; &quot;  id: &quot; &lt;&lt; v &lt;&lt; endl;
}
</code></pre>

<p>在 Linux 系统编译执行结果如下：</p>

<pre><code class="language-sh"># ./xx
fsys use 299251us  id: 71
ftls use 2675us  id: 71
</code></pre>

<p>可以看到 <code>TLS</code> 版本性能提升了将近 100 倍，效果非常明显。</p>

<p>我在 windows 上也进行了类似的测试，结果表明 TLS 对性能没什么影响，可能 windows 的 api 内部就是用 TLS 机制实现的。</p>


  <footer>
  



<nav class="post-nav">
  <ul>
     
    <li>
      <span class="date">&rtrif; 2018/10/09&emsp;</span>
      <a href="/coding/2018/10/namespace-log/">解决 namespace log 与 math 库 log() 函数的冲突</a>
    </li>
    
    <li class="active">
      <span class="date">&rtrif; 2018/09/28&emsp;</span>
      <a href="/coding/2018/09/get-current-thread-id/">高效获取当前线程的 id</a>     
    </li>
    
    <li>
      <span class="date">&rtrif; 2018/09/09&emsp;</span>
      <a href="/coding/2018/09/vim/">无处不在的 vim</a>
    </li>
    
  </ul>
</nav>


<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.6.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.6.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>     
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '78371628e00f43aff18e',
    clientSecret: '6905d0b807b7008ea04b420bb9fd9a7f390ec400',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false
  })
  
  gitalk.render('gitalk-container');
</script>

  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/bash.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">&copy;2018-2020 <a href="/">Alvin Yih</a> | <a href="https://github.com/idealvin">Github</a></div>
  
  </footer>
  </article>
  
  
  </body>
</html>

